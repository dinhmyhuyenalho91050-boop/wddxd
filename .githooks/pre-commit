#!/usr/bin/env bash
set -euo pipefail
patterns=( "*.jar" "*.aar" "*.zip" "*.so" "*.png" "*.jpg" "*.jpeg" "*.webp" "*.gif" "*.ttf" "*.otf" )
git lfs env >/dev/null 2>&1 || exit 0

convert() {
  local f="$1"
  # 未受 LFS 追踪则自动 track 相应模式，并把 .gitattributes 纳入本次提交
  if ! git check-attr -a -- "$f" | grep -q 'filter: lfs'; then
    for p in "${patterns[@]}"; do case "$f" in $p) git lfs track "$p"; git add .gitattributes; break ;; esac; done
  fi
  # 重新加入索引，触发 LFS 过滤器（把文件变成 LFS 指针）
  git add -f -- "$f"
  echo "[pre-commit] LFS pointer: $f"
}

# 处理 新增(A) + 修改(M)
while IFS= read -r f; do
  [ -f "$f" ] || continue
  for p in "${patterns[@]}"; do case "$f" in $p) convert "$f"; break ;; esac; done
done < <(git diff --cached --name-only --diff-filter=AM)

exit 0
