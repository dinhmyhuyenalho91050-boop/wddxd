<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>AI Chat v9.3 (IndexedDB + Optimized)</title>
<style>
  :root{
    --bg:#0a0e14;--fg:#e6e8eb;--muted:#9ca3af;--panel:#151921;--accent:#fbbf24;--accent2:#60a5fa;
    --accent3:#10b981;--danger:#ef4444;--border:#1f2937;--shadow:rgba(0,0,0,.3);--glow:rgba(96,165,250,.15);
    --transition-fast:.15s cubic-bezier(0.4,0,0.2,1);--transition-normal:.2s ease;--transition-slow:.3s cubic-bezier(.4,0,.2,1);
    --shadow-sm:0 2px 8px var(--shadow);--shadow-md:0 4px 16px var(--shadow);--shadow-lg:0 22px 60px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{overflow:hidden;background:linear-gradient(135deg,#0a0e14 0%,#141824 100%);color:var(--fg);
       font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;-webkit-font-smoothing:antialiased}
  .app{display:flex;flex-direction:column;height:100vh}
  header{flex-shrink:0;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 1.25rem;
    background:linear-gradient(180deg,rgba(21,25,33,.98),rgba(10,14,20,1));border-bottom:1px solid var(--border);
    box-shadow:var(--shadow-sm);z-index:100}
  header h1{font-size:18px;font-weight:600;display:flex;align-items:center;gap:.6rem;
    background:linear-gradient(135deg,var(--accent2),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .pill{padding:.25rem .65rem;border:1px solid var(--border);border-radius:999px;background:var(--panel);color:var(--muted);
    font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
  .header-actions{display:flex;gap:.5rem}
  .btn{border:1px solid var(--border);background:var(--panel);color:var(--fg);padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;
       font-size:13px;font-weight:600;transition:all var(--transition-fast);white-space:nowrap;user-select:none;touch-action:manipulation}
  .btn:hover{background:rgba(96,165,250,.1);border-color:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 12px rgba(96,165,250,.2)}
  .btn:active{transform:scale(0.96);transition-duration:.05s}
  .btn.primary{background:linear-gradient(135deg,var(--accent2),#3b82f6);border-color:transparent;color:#fff}
  .btn.warn{background:linear-gradient(135deg,var(--danger),#dc2626);border-color:transparent;color:#fff}
  .btn.small{padding:.3rem .65rem;font-size:12px;border-radius:.4rem}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.sending{position:relative;animation:btnpulse .9s ease-in-out infinite alternate}
  .btn.sending .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.45);border-top-color:#fff;border-radius:50%;
    margin-right:.5rem;vertical-align:-2px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes btnpulse{from{transform:translateY(0)}to{transform:translateY(-1px)}}
  main{flex:1;display:flex;overflow:hidden}
  .side{width:300px;background:linear-gradient(180deg,var(--panel) 0%,var(--bg) 100%);border-right:1px solid var(--border);
        display:flex;flex-direction:column;flex-shrink:0}
  .side-header{padding:1rem;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2)}
  .new-chat-group{display:flex;gap:.5rem}
  .model-selector{display:flex;gap:.25rem;padding:.25rem;background:rgba(0,0,0,.3);border-radius:.5rem;border:1px solid var(--border)}
  .model-selector button{flex:1;padding:.4rem .8rem;border:none;background:transparent;color:var(--muted);cursor:pointer;border-radius:.35rem;
    font-size:12px;font-weight:600;transition:all var(--transition-normal);touch-action:manipulation}
  .model-selector button.active{background:var(--accent2);color:#fff;box-shadow:0 2px 8px rgba(96,165,250,.3)}
  .model-selector button:hover:not(.active){background:rgba(96,165,250,.1)}
  .model-selector button:active{transform:scale(0.94);transition-duration:.05s}
  .sessions{flex:1;overflow:auto;padding:.75rem}
  .sessions::-webkit-scrollbar{width:0;height:0}
  .sessions{scrollbar-width:none;-ms-overflow-style:none}
  .session{display:flex;flex-direction:column;gap:.5rem;padding:.85rem;border:1px solid var(--border);border-radius:.75rem;
    background:rgba(21,25,33,.6);margin-bottom:.75rem;transition:all var(--transition-normal);cursor:pointer;touch-action:manipulation}
  .session:hover{background:rgba(96,165,250,.05);border-color:var(--accent2);transform:translateX(3px);box-shadow:0 2px 8px var(--glow)}
  .session:active{transform:scale(0.98) translateX(3px);transition-duration:.05s}
  .session.active{border-color:var(--accent2);background:rgba(96,165,250,.08)}
  .session .name{font-weight:600;font-size:14px}
  .session .sub{color:var(--muted);font-size:11px;display:flex;align-items:center;gap:.5rem}
  .session .actions{display:flex;gap:.4rem;margin-top:.25rem}
  @media (max-width:820px){
    .side{position:fixed;left:0;top:60px;width:min(85vw,320px);height:calc(100vh - 60px);transform:translateX(-100%);
      transition:transform var(--transition-slow);box-shadow:4px 0 24px var(--shadow);z-index:90}
    .side.open{transform:translateX(0)}
    #backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);opacity:0;pointer-events:none;transition:opacity .3s;z-index:80}
    #backdrop.show{opacity:1;pointer-events:auto}
  }
  .chat{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .messages{flex:1;overflow:auto;padding:1rem;min-height:120px;position:relative;padding-bottom:calc(var(--composer-pad, 0px) + 1rem);}
  .messages::-webkit-scrollbar{width:0;height:0}
  .messages{scrollbar-width:none;-ms-overflow-style:none}
  @media (max-width:640px){.messages{padding:.75rem .5rem}}
  .msg{max-width:900px;margin:0 auto 1rem;border:1px solid var(--border);border-radius:1rem;
    background:linear-gradient(135deg,rgba(21,25,33,.8),rgba(15,18,25,.9));box-shadow:var(--shadow-md)}
  .msg header{display:flex;justify-content:space-between;align-items:center;padding:.7rem 1rem;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2)}
  .msg .role{font-weight:600;font-size:12px;display:flex;align-items:center;gap:.5rem}
  .msg .model-badge{padding:.15rem .5rem;border-radius:999px;font-size:10px;font-weight:600;text-transform:uppercase;
    background:rgba(96,165,250,.2);color:var(--accent2);border:1px solid var(--accent2)}
  .msg .body{padding:1rem;line-height:1.7;word-wrap:break-word}
  .msg footer{display:flex;gap:.4rem;justify-content:flex-end;flex-wrap:wrap;padding:.7rem 1rem;border-top:1px solid var(--border);background:rgba(0,0,0,.15)}
  .msg.user{border-left:3px solid var(--accent2)}
  .msg.assistant{border-left:3px solid #64d2ff}
  .msg.assistant .typing-cursor{display:inline-block;width:2px;height:1em;background:var(--accent2);margin-left:2px;animation:blink 1s infinite;vertical-align:text-bottom}
  .body em.em-yellow{color:var(--accent);font-style:italic;font-weight:600}
  .body em.em-green{color:var(--accent3);font-style:italic;font-weight:600}
  .msg .edit-box{width:100%;min-height:110px;border:1px solid var(--accent2);border-radius:.6rem;background:rgba(96,165,250,.08);
    color:var(--fg);padding:.7rem .8rem;font:inherit;line-height:1.6;outline:none;box-shadow:0 0 0 3px var(--glow)}
  
  /* 思维链样式 */
  details{transition:all .2s ease}
  details[open]{background:rgba(96,165,250,.08)!important}
  details summary{transition:color .2s ease}
  details summary:hover{color:var(--accent)!important}
  details summary::marker{color:var(--accent2)}
  .composer{flex-shrink:0;display:flex;flex-direction:column;gap:.75rem;padding:.75rem;border-top:1px solid var(--border);
    background:linear-gradient(180deg,rgba(21,25,33,.98),rgba(10,14,20,1))}
  .composer-header{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .composer-header .model-selector{flex:1;max-width:400px}
  .composer-main{display:flex;gap:.6rem}
  .composer textarea{flex:1;resize:none;min-height:44px;max-height:30vh;border:1px solid var(--border);border-radius:.75rem;background:var(--panel);
    color:var(--fg);padding:.7rem .9rem;font-family:inherit;font-size:15px;line-height:1.5;touch-action:manipulation}
  .composer textarea:focus{outline:none;border-color:var(--accent2);box-shadow:0 0 0 3px var(--glow)}
  .composer textarea::placeholder{color:var(--muted)}
  dialog{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);margin:0;border:none;border-radius:1rem;background:var(--panel);color:var(--fg);
    width:min(960px,94vw);max-height:88vh;padding:0;box-shadow:var(--shadow-lg);z-index:1200}
  dialog::backdrop{background:rgba(0,0,0,.7)}
  .settings{display:grid;grid-template-columns:200px 1fr;min-height:500px}
  .settings .tabs{border-right:1px solid var(--border);background:rgba(0,0,0,.2);overflow:auto}
  .settings .tabs::-webkit-scrollbar{width:0;height:0}
  .settings .tabs{scrollbar-width:none;-ms-overflow-style:none}
  .settings .tabs button{display:block;width:100%;text-align:left;padding:1rem;border:none;background:transparent;color:var(--muted);
    border-bottom:1px solid var(--border);cursor:pointer;font-size:13px;font-weight:600}
  .settings .tabs button.active{background:rgba(96,165,250,.15);color:var(--accent2);border-left:3px solid var(--accent2)}
  .settings .pane{padding:1.2rem;max-height:72vh;overflow:auto}
  .settings .pane::-webkit-scrollbar{width:0;height:0}
  .settings .pane{scrollbar-width:none;-ms-overflow-style:none}
  #promptPresetList::-webkit-scrollbar{width:0;height:0}
  .field{display:grid;grid-template-columns:140px 1fr;gap:.75rem;align-items:start;margin-bottom:1rem}
  .field label{padding-top:.45rem;color:var(--muted);font-size:13px;font-weight:600}
  .field input,.field select,.field textarea{width:100%;border:1px solid var(--border);border-radius:.55rem;background:rgba(0,0,0,.28);color:var(--fg);
    padding:.5rem .75rem;font-family:inherit;font-size:14px}
  .field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent2);box-shadow:0 0 0 3px var(--glow)}
  .model-preset-card{border:1px solid var(--border);border-radius:.75rem;padding:1rem;margin-bottom:1rem;
    background:linear-gradient(135deg,rgba(21,25,33,.7),rgba(15,18,25,.8))}
  .model-preset-card h3{font-size:14px;margin-bottom:.75rem;color:var(--accent2)}
  .sep{height:1px;background:var(--border);margin:1.2rem 0}
  .hint{color:var(--muted);font-size:11px}
  .dialog-footer{padding:1rem 1.2rem;border-top:1px solid var(--border);grid-column:1/-1;display:flex;gap:.75rem;justify-content:flex-end;background:rgba(0,0,0,.18)}
  .error-toast{position:fixed;top:80px;right:20px;background:var(--danger);color:#fff;padding:.75rem 1rem;border-radius:.5rem;
    box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;animation:slideIn .3s ease;max-width:300px;word-wrap:break-word}
  .error-toast.hide{animation:slideOut .3s ease forwards}
  @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes slideOut{to{transform:translateX(100%);opacity:0}}
  @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
  .load-older{position:sticky;top:0;z-index:5;margin:0 auto 1rem;max-width:900px;display:flex;align-items:center;justify-content:space-between;
    padding:.5rem .75rem;border:1px dashed var(--border);border-radius:.75rem;background:rgba(0,0,0,.25)}
  .load-older .info{font-size:12px;color:var(--muted)}
  .sentinel{height:1px;pointer-events:none;visibility:hidden}
  @media (min-width:821px){
    .side{position:fixed;left:0;top:60px;width:min(85vw,320px);height:calc(100vh - 60px);transform:translateX(-100%);
      transition:transform var(--transition-slow);box-shadow:4px 0 24px var(--shadow);z-index:90}
    .side.open{transform:translateX(0)}
    #backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);opacity:0;pointer-events:none;transition:opacity .3s;z-index:80}
    #backdrop.show{opacity:1;pointer-events:auto}
  }
  @media (max-width:768px){
    .settings{grid-template-columns:1fr}
    .settings .tabs{display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border)}
    .settings .tabs button{white-space:nowrap;border-bottom:none;border-right:1px solid var(--border)}
  }
  
  /* 预设选择对话框样式 */
  #dlgSelectPreset{width:min(700px,92vw)}
  #presetSelectGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
  @media (max-width:640px){
    #presetSelectGrid{grid-template-columns:1fr}
  }
  .preset-card{
    border:2px solid var(--border);border-radius:1rem;padding:1.25rem;cursor:pointer;
    background:linear-gradient(135deg,rgba(21,25,33,.8),rgba(15,18,25,.9));
    transition:all var(--transition-normal);position:relative;overflow:hidden;
    display:flex;flex-direction:column;gap:.75rem;min-height:140px
  }
  .preset-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--accent2),var(--accent));opacity:0;transition:opacity var(--transition-fast)
  }
  .preset-card:hover{
    border-color:var(--accent2);transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(96,165,250,.2)
  }
  .preset-card:hover::before{opacity:1}
  .preset-card:active{transform:translateY(0) scale(0.98)}
  .preset-card-name{font-size:16px;font-weight:600;color:var(--fg)}
  .preset-card-desc{
    font-size:12px;color:var(--muted);line-height:1.5;
    display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
    flex:1
  }
  .preset-card-footer{
    display:flex;align-items:center;justify-content:space-between;
    padding-top:.5rem;border-top:1px solid var(--border);font-size:11px;color:var(--muted)
  }
  .preset-card-icon{
    width:32px;height:32px;border-radius:.5rem;display:flex;align-items:center;justify-content:center;
    background:rgba(96,165,250,.15);font-size:18px;margin-bottom:.25rem
  }

  /* === Motion System (safe, perf-friendly) === */
  @media (prefers-reduced-motion:no-preference){
    .msg.is-entering{opacity:0;transform:translateY(8px)}
    .msg.is-entering.is-active{transition:opacity .22s ease, transform .22s ease;opacity:1;transform:none}
    .msg.is-exiting{transition:opacity .2s ease, transform .2s ease;opacity:0;transform:translateY(-6px)}
    dialog[open]{animation:dlg-in .22s ease}
    @keyframes dlg-in{from{opacity:0;transform:translate(-50%,-48%) scale(.98)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    .settings .pane{animation:fade-swap .2s ease}
    @keyframes fade-swap{from{opacity:.7;transform:translateY(4px)}to{opacity:1;transform:none}}
  }
  .btn{position:relative;overflow:hidden}
  .btn::after{content:'';position:absolute;inset:0;border-radius:inherit;opacity:0;transform:scale(.98);
    transition:opacity .2s,transform .2s;background:linear-gradient(135deg,rgba(255,255,255,.25),rgba(255,255,255,.05));pointer-events:none}
  .btn:active::after{opacity:.12;transform:scale(.95)}


  /* === Mobile viewport stability & IME flicker fixes === */
  html,body{height:100%}
  #app{min-height:100svh;height:100dvh}
  @supports not (height:100dvh){
    #app{height:100vh}
  }
  /* During viewport freeze, lock height and disable scroll anchoring that can cause jumps */
  body.vp-freeze #app{height:var(--vp-lock-h,100dvh)}
  #messages{overflow-anchor:auto}
  body.vp-freeze #messages{overflow-anchor:none}
  /* Avoid transitions fighting during viewport changes */
  body.vp-freeze *{scroll-behavior:auto !important}


  /* === Mobile IME flicker hardening (override) === */
  /* Prefer the STABLE viewport units to avoid jumps when address bar/IME changes */
  #app{min-height:100svh !important;height:100svh !important}
  @supports (height:100dvh){
    /* Use svh as authoritative; dvh can still jump when IME hides */
    #app{min-height:100svh !important;height:100svh !important}
  }
  /* Prevent rubber-banding from interfering with scroll position during transitions */
  html,body{overscroll-behavior-y:contain}
  #messages{backface-visibility:hidden;transform:translateZ(0);overscroll-behavior:contain}


/* === Chat editing UX enhancements (patch) === */
.msg .edit-box{
  min-height: clamp(240px, 50vh, 70vh);
  max-height: none;
  width: 100%;
  resize: vertical;
  line-height: 1.7;
  white-space: pre-wrap;
}
.msg.editing{
  max-width: min(1200px, 96vw);
}
/* Optional: make full-width while editing (uncomment if desired) */
/*
.msg.editing{ max-width: 100%; border-radius: .5rem; }
*/

/* === Performance patch (strict, no fallback) === */
.msg{
  contain: content;             /* layout+paint+style isolation to reduce reflow/paint */
  content-visibility: auto;     /* skip layout/paint when offscreen */
  contain-intrinsic-size: 0 140px; /* estimated height to avoid scroll jump on first reveal */
}
/* === End of performance patch === */
</style>
<style>
/* === Stream Tail Soft Lock (avoid selection during streaming) === */
.msg[data-streaming="1"] [data-stream-tail]{
  user-select: none;
  pointer-events: none;
}
/* === End Soft Lock === */
</style>
</head>
<body>
<div id="app" class="app">
  <header>
    <h1><span>AI Chat</span><span class="pill">v9.3⚡</span></h1>
    <div class="header-actions">
      <button class="btn" id="btnSessions">对话列表</button>
      <button class="btn" id="btnSettings">设置</button>
    </div>
  </header>
  <main>
    <aside class="side" id="sidebar" hidden>
      <div class="side-header">
        <div class="new-chat-group">
          <div class="model-selector" id="newChatModelSelector"></div>
          <button class="btn primary" id="btnNew" style="flex-shrink:0">新建</button>
        </div>
      </div>
      <div class="sessions" id="sessionList"></div>
    </aside>
    <section class="chat">
      <div class="messages" id="messages"></div>
      <div class="composer">
        <div class="composer-header">
          <div class="model-selector" id="composerModelSelector"></div>
        </div>
        <div class="composer-main">
          <textarea id="input" placeholder="输入消息后点击右侧“发送”"></textarea>
          <button class="btn primary" id="send">发送</button>
        </div>
      </div>
    </section>
  </main>
  <div id="backdrop" hidden></div>
  <dialog id="dlgSettings">
    <div class="settings">
      <nav class="tabs">
        <button type="button" data-pane="models" class="active">模型预设</button>
        <button type="button" data-pane="prompts">提示词</button>
        <button type="button" data-pane="backup">备份</button>
      </nav>
      <div class="pane" id="pane-models">
        <h2 style="font-size:16px;margin-bottom:1rem">模型预设配置(最多2个)</h2>
        <div class="model-preset-card">
          <h3>预设1</h3>
          <div class="field"><label>启用</label><select id="model1Enable"><option value="true">是</option><option value="false">否</option></select></div>
          <div class="field"><label>显示名称</label><input id="model1Name" placeholder="如: GPT-4"/></div>
          <div class="field"><label>模型类型</label><select id="model1Type"><option value="openai">OpenAI</option><option value="gemini">Gemini直连</option><option value="gemini-proxy">Gemini代理</option></select></div>
          <div id="model1Config"></div>
        </div>
        <div class="model-preset-card">
          <h3>预设2</h3>
          <div class="field"><label>启用</label><select id="model2Enable"><option value="true">是</option><option value="false">否</option></select></div>
          <div class="field"><label>显示名称</label><input id="model2Name" placeholder="如: Gemini"/></div>
          <div class="field"><label>模型类型</label><select id="model2Type"><option value="openai">OpenAI</option><option value="gemini">Gemini直连</option><option value="gemini-proxy">Gemini代理</option></select></div>
          <div id="model2Config"></div>
        </div>
      </div>
      <div class="pane" id="pane-prompts" hidden>
        <div style="display:grid;grid-template-columns:240px 1fr;gap:1rem;align-items:start">
          <div>
            <h3 style="font-size:14px;margin-bottom:.75rem">提示词预设</h3>
            <div style="border:1px solid var(--border);border-radius:.75rem;background:rgba(21,25,33,.6);max-height:400px;overflow-y:auto;padding:.5rem;margin-bottom:1rem;scrollbar-width:none;-ms-overflow-style:none" id="promptPresetList"></div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
              <h3 style="font-size:14px">编辑预设</h3>
              <div style="font-size:11px;color:var(--muted)" id="promptEditingHint">未选择预设</div>
            </div>
            <div class="field" style="grid-template-columns:1fr"><label>预设名称</label><input id="promptPresetName" placeholder="如: 默认预设"/></div>
            <div class="field" style="grid-template-columns:1fr"><label>系统提示</label><textarea id="sysPrompt" rows="4" placeholder="隐藏但每次发送"></textarea></div>
            <div class="field" style="grid-template-columns:1fr"><label>首条用户消息</label><textarea id="firstUser" rows="5" placeholder="隐藏但每次发送"></textarea></div>
            <div class="field" style="grid-template-columns:1fr"><label>首条助手消息</label><textarea id="firstAssistant" rows="5" placeholder="进入对话即显示"></textarea></div>
            <div class="sep"></div>
            <div class="field" style="grid-template-columns:1fr"><label>消息前缀</label><textarea id="messagePrefix" rows="3" placeholder="拼接到最新用户消息前(可选)"></textarea></div>
            <div class="field" style="grid-template-columns:1fr"><label>助手预填充</label><textarea id="assistantPrefill" rows="3" placeholder="引导助手回复开头(可选)"></textarea></div>
            <div class="sep"></div>
            <div style="margin-bottom:1rem">
              <div style="font-weight:600;font-size:13px;margin-bottom:.5rem;color:var(--muted)">正则替换规则(生成后处理)</div>
              <div id="regexRulesContainer"></div>
              <button type="button" class="btn small" id="btnAddRegexRule" style="margin-top:.5rem">+ 添加规则</button>
            </div>
            <div class="sep"></div>
            <div style="display:flex;gap:.75rem">
              <button class="btn" id="btnSavePromptPreset">保存为新预设</button>
              <button class="btn" id="btnUpdatePromptPreset">更新当前预设</button>
              <button class="btn warn" id="btnDeletePromptPreset">删除预设</button>
            </div>
          </div>
        </div>
      </div>
      <div class="pane" id="pane-backup" hidden>
        <h2 style="font-size:16px;margin-bottom:1rem">数据备份与恢复</h2>
        
        <div style="background:rgba(96,165,250,.08);border:1px solid var(--accent2);border-radius:.75rem;padding:1rem;margin-bottom:1.5rem">
          <div style="font-weight:600;margin-bottom:.5rem;color:var(--accent2)">✅ 存储说明</div>
          <div style="font-size:13px;line-height:1.6;color:var(--fg)">
            使用 IndexedDB 存储，容量更大（几百MB），性能更好！<br/>
            • 浏览器存储限制：通常为可用磁盘的 50%<br/>
            • 清除浏览器数据会导致数据丢失<br/>
            <strong style="color:var(--accent)">建议定期导出备份重要对话！</strong>
          </div>
        </div>

        <div class="model-preset-card">
          <h3>导出数据</h3>
          <p style="font-size:13px;color:var(--muted);margin-bottom:1rem">
            导出所有模型预设、提示词预设和对话记录为JSON文件
          </p>
          <div style="display:grid;gap:.75rem">
            <button class="btn primary" id="btnExportAll" style="justify-self:start">
              <span style="margin-right:.5rem">📦</span>导出所有数据
            </button>
            <button class="btn" id="btnExportSessions" style="justify-self:start">
              <span style="margin-right:.5rem">💬</span>仅导出对话记录
            </button>
            <button class="btn" id="btnExportPresets" style="justify-self:start">
              <span style="margin-right:.5rem">⚙️</span>仅导出配置预设
            </button>
          </div>
        </div>

        <div class="model-preset-card">
          <h3>导入数据</h3>
          <p style="font-size:13px;color:var(--muted);margin-bottom:1rem">
            从JSON备份文件恢复数据
          </p>
          <div style="display:grid;gap:.75rem">
            <div class="field" style="grid-template-columns:1fr">
              <label>导入模式</label>
              <select id="importMode">
                <option value="merge">合并模式(保留现有数据,合并导入)</option>
                <option value="replace">替换模式(清空现有数据,完全替换)</option>
              </select>
            </div>
            <input type="file" id="fileImport" accept=".json" style="display:none"/>
            <button class="btn primary" id="btnImport" style="justify-self:start">
              <span style="margin-right:.5rem">📥</span>选择文件导入
            </button>
          </div>
        </div>

        <div class="model-preset-card">
          <h3>存储信息</h3>
          <div style="font-size:13px;line-height:1.8;color:var(--fg)">
            <div style="display:grid;grid-template-columns:120px 1fr;gap:.5rem" id="storageInfo">
              <span style="color:var(--muted)">对话数量:</span><span id="sessionCount">-</span>
              <span style="color:var(--muted)">消息总数:</span><span id="messageCount">-</span>
              <span style="color:var(--muted)">模型预设:</span><span id="modelPresetCount">-</span>
              <span style="color:var(--muted)">提示词预设:</span><span id="promptPresetCount">-</span>
              <span style="color:var(--muted)">预估大小:</span><span id="dataSize">-</span>
            </div>
          </div>
        </div>

        <div style="background:rgba(239,68,68,.08);border:1px solid var(--danger);border-radius:.75rem;padding:1rem">
          <div style="font-weight:600;margin-bottom:.5rem;color:var(--danger)">🗑️ 危险操作</div>
          <p style="font-size:13px;color:var(--muted);margin-bottom:.75rem">
            清空所有数据将无法恢复,请确保已导出备份
          </p>
          <button class="btn warn" id="btnClearAll">清空所有数据</button>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="btn" type="button" id="btnCloseSettings">关闭</button>
        <button class="btn primary" type="button" id="btnApplySettings">应用</button>
      </div>
    </div>
  </dialog>
  
  <dialog id="dlgSelectPreset">
    <div style="padding:0">
      <div style="padding:1.5rem;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2)">
        <h2 style="font-size:18px;font-weight:600;margin:0;background:linear-gradient(135deg,var(--accent2),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">选择提示词预设</h2>
        <p style="font-size:13px;color:var(--muted);margin-top:.5rem">为新对话选择一个提示词预设配置</p>
      </div>
      <div style="padding:1.5rem;max-height:60vh;overflow-y:auto" id="presetSelectGrid">
        <!-- 预设卡片将在这里动态生成 -->
      </div>
      <div style="padding:1rem 1.5rem;border-top:1px solid var(--border);background:rgba(0,0,0,.18);display:flex;gap:.75rem;justify-content:flex-end">
        <button class="btn" type="button" id="btnCancelSelectPreset">取消</button>
      </div>
    </div>
  </dialog>
</div>
<script>
(function(){'use strict';

// ===== 配置 - 降低虚拟化阈值 =====
const CONFIG={
  MSG_VLIST_THRESHOLD:50,
  MSG_WINDOW_TAIL:30,
  MSG_WINDOW_BUFFER:10,
  AUTO_FOLLOW_PX:60,
  MSG_LOAD_CHUNK:40,
  THROTTLE_DELAY:80,
  DEBOUNCE_DELAY:300,
  PERSIST_DELAY:100,
  IDLE_TIMEOUT:2000,
  STORAGE_KEYS:{
    modelPresets:'chat.modelPresets',
    sessions:'chat.sessions',
    currentId:'chat.currentId',
    promptPresets:'chat.promptPresets'
  }
};

const RX_PATTERNS={
  quote:/[""\u201C\u201D\uFF02]([^""\u201C\u201D\uFF02]+?)[""\u201C\u201D\uFF02]/g,
  star:/[\*\uFF0A]([^\*\uFF0A]+?)[\*\uFF0A]/g,
  newline:/\n/g,
  hasSpecial:/[""\u201C\u201D\uFF02\*\uFF0A]/
};

const SPECIAL_CHARS=new Set([34,42,8220,8221,65282,65290]);

// ===== SmartSanitizer - ✅ 简化版：全量处理更快 =====
class SmartSanitizer{
  constructor(){
    this.cache=new Map();
    this.maxCacheSize=500;
  }
  
  sanitize(text,isStreaming=false,streamId=null){
    if(!text)return '';
    
    // 流式输出时不使用缓存，直接全量处理（更快更稳定）
    if(isStreaming)return this.process(text);
    
    // 非流式才使用缓存（历史消息）
    if(this.cache.has(text))return this.cache.get(text);
    const result=this.process(text);
    this.addToCache(text,result);
    return result;
  }
  
  process(text){
    let s=String(text);
    if(!RX_PATTERNS.hasSpecial.test(s))return s.replace(RX_PATTERNS.newline,'<br/>');
    s=s.replace(RX_PATTERNS.quote,(m,content)=>`<em class='em-green'>"${content}"</em>`);
    s=s.replace(RX_PATTERNS.star,(m,content)=>`<em class='em-yellow'>${content}</em>`);
    return s.replace(RX_PATTERNS.newline,'<br/>');
  }
  
  addToCache(key,value){
    if(this.cache.size>=this.maxCacheSize){
      const firstKey=this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key,value);
  }
}

// ===== DOMDiffer - 保留改进的append优化 =====
class DOMDiffer{
  constructor(){
    this.cache=new WeakMap();
  }
  
  updateHTML(el,newHTML){
    const oldHTML=this.cache.get(el);
    if(oldHTML===newHTML)return;
    
    // ✅ 前缀检查+insertAdjacentHTML优化
    if(oldHTML&&newHTML.startsWith(oldHTML)){
      const diff=newHTML.slice(oldHTML.length);
      const temp=document.createElement('div');
      temp.innerHTML=diff;
      const cursor=el.querySelector('.typing-cursor');
      if(cursor)cursor.remove();
      while(temp.firstChild)el.appendChild(temp.firstChild);
      if(cursor)el.appendChild(cursor);
      this.cache.set(el,newHTML);
      return;
    }
    
    el.innerHTML=newHTML;
    this.cache.set(el,newHTML);
  }
}

// ===== AdaptiveStreamBatcher =====
class AdaptiveStreamBatcher{
  constructor(updateFn){
    this.updateFn=updateFn;
    this.buffer='';
    this.thinkingBuffer='';
    this.rafId=null;
    this.timeoutId=null;
    this.lastUpdate=0;
    this.updateCount=0;
    this.windowStart=Date.now();
    this.currentInterval=30;
    this.avgRenderTime=0;
    this.renderSamples=[];
  }
  
  push(text,thinking){
    this.buffer=text;
    this.thinkingBuffer=thinking||'';
    this.updateCount++;
    this.scheduleUpdate();
  }
  
  scheduleUpdate(){
    if(this.rafId)return;
    const now=performance.now();
    const elapsed=now-this.lastUpdate;
    this.adjustInterval();
    
    if(elapsed>=this.currentInterval){
      this.rafId=requestAnimationFrame(()=>this.flush());
    }else{
      if(this.timeoutId)clearTimeout(this.timeoutId);
      this.timeoutId=setTimeout(()=>{
        this.rafId=requestAnimationFrame(()=>this.flush());
      },this.currentInterval-elapsed);
    }
  }
  
  flush(){
    const start=performance.now();
    try{
      this.updateFn(this.buffer,this.thinkingBuffer);
    }catch{}
    const renderTime=performance.now()-start;
    this.recordRenderTime(renderTime);
    this.lastUpdate=performance.now();
    this.rafId=null;
    this.timeoutId=null;
  }
  
  adjustInterval(){
    const now=Date.now();
    const windowDuration=now-this.windowStart;
    if(windowDuration<1000)return;
    
    const updatesPerSec=this.updateCount/(windowDuration/1000);
    if(updatesPerSec>40||this.avgRenderTime>12){
      this.currentInterval=60;
    }else if(updatesPerSec<20&&this.avgRenderTime<5){
      this.currentInterval=20;
    }else{
      this.currentInterval=30;
    }
    
    this.updateCount=0;
    this.windowStart=now;
  }
  
  recordRenderTime(time){
    this.renderSamples.push(time);
    if(this.renderSamples.length>10)this.renderSamples.shift();
    this.avgRenderTime=this.renderSamples.reduce((a,b)=>a+b,0)/this.renderSamples.length;
  }
  
  stop(){
    if(this.rafId){
      cancelAnimationFrame(this.rafId);
      this.rafId=null;
    }
    if(this.timeoutId){
      clearTimeout(this.timeoutId);
      this.timeoutId=null;
    }
    this.flush();
  }
}

// ===== LeakSafeObserverManager =====
class LeakSafeObserverManager{
  constructor(){
    this.observers=new Map();
    this.observedElements=new WeakMap();
  }
  
  create(type,container,callback,options){
    this.cleanup(type);
    const observer=new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(!entry.target.isConnected){
          observer.unobserve(entry.target);
          return;
        }
        callback(entry);
      });
    },{root:container,...options});
    
    this.observers.set(type,{observer,container,elements:new Set()});
    return observer;
  }
  
  observe(type,element){
    const data=this.observers.get(type);
    if(!data)return;
    data.observer.observe(element);
    data.elements.add(element);
    this.observedElements.set(element,type);
  }
  
  unobserve(type,element){
    const data=this.observers.get(type);
    if(!data)return;
    try{
      data.observer.unobserve(element);
      data.elements.delete(element);
    }catch{}
  }
  
  cleanup(type){
    const data=this.observers.get(type);
    if(!data)return;
    data.elements.forEach(el=>{
      try{data.observer.unobserve(el);}catch{}
    });
    try{data.observer.disconnect();}catch{}
    data.elements.clear();
    this.observers.delete(type);
  }
  
  cleanupAll(){
    for(const type of this.observers.keys()){
      this.cleanup(type);
    }
  }
}

// ===== DOMPool - 改进子元素复用 =====
class DOMPool{
  constructor(){
    this.pools=new Map();
    this.maxPoolSize=50;
  }
  
  acquire(tagName,className){
    const pool=this.pools.get(tagName);
    if(pool&&pool.length>0){
      const el=pool.pop();
      el.className=className;
      return el;
    }
    const el=document.createElement(tagName);
    el.className=className;
    return el;
  }
  
  release(tagName,element){
    if(!element)return;
    if(!this.pools.has(tagName))this.pools.set(tagName,[]);
    const pool=this.pools.get(tagName);
    if(pool.length<this.maxPoolSize){
      element.className='';
      element.removeAttribute('data-id');
      // 注意：不清空innerHTML，让buildMessageElement复用子元素
      pool.push(element);
    }
  }
  
  clear(){
    this.pools.clear();
  }
}

// ===== RegexProcessor =====
class RegexProcessor{
  compileRules(rules){
if (!Array.isArray(rules) || rules.length === 0) return null;

const compiled = [];
for (const rule of rules) {
  if (!rule || !rule.pattern) continue;
  try {
    let source = rule.pattern;
    let flags = '';

    // 允许用户写 JS 字面量：/pattern/flags
    // 若不是字面量，兼容旧字段 rule.flags，但不再强加任何 flag
    if (typeof source === 'string') {
      const m = source.match(/^\/([\s\S]*)\/([a-z]*)$/i);
      if (m) {
        source = m[1];
        flags = m[2] || '';
      } else if (rule.flags) {
        flags = String(rule.flags || '');
      }
    }

    const regex = new RegExp(source, flags);
    compiled.push({ regex, replacement: (rule.replacement ?? '') });
  } catch (e) {
    // 单条无效规则忽略
  }
}
return compiled.length ? compiled : null;
}

process(text,compiledRules){
    if(!text||!compiledRules)return text;
    let result=text;
    for(const rule of compiledRules){
      try{
        result=result.replace(rule.regex,rule.replacement);
      }catch(e){}
    }
    return result;
  }
}

// ===== EventHub - 添加passive支持 =====
class EventHub{
  constructor(){
    this.listeners=new WeakMap();
    this.unbinders=[];
    this.timeouts=new Set();
    this.intervals=new Set();
  }
  
  on(el,type,handler,opts){
    if(!el)return ()=>{};
    
    // ✅ 自动为滚动事件添加passive
    if(opts===undefined&&['scroll','wheel','touchmove','touchstart'].includes(type)){
      opts={passive:true};
    }
    
    el.addEventListener(type,handler,opts);
    if(!this.listeners.has(el))this.listeners.set(el,new Set());
    this.listeners.get(el).add({type,handler,opts});
    
    const off=()=>{
      try{
        el.removeEventListener(type,handler,opts);
        const set=this.listeners.get(el);
        if(set){
          for(const item of set){
            if(item.type===type&&item.handler===handler){
              set.delete(item);
              break;
            }
          }
          if(set.size===0)this.listeners.delete(el);
        }
      }catch{}
    };
    this.unbinders.push(off);
    return off;
  }
  
  setTimeout(fn,delay){
    const id=window.setTimeout(()=>{
      this.timeouts.delete(id);
      try{fn();}catch{}
    },delay);
    this.timeouts.add(id);
    return id;
  }
  
  clearTimeout(id){
    if(this.timeouts.has(id)){
      clearTimeout(id);
      this.timeouts.delete(id);
    }
  }
  
  setInterval(fn,delay){
    const id=window.setInterval(fn,delay);
    this.intervals.add(id);
    return id;
  }
  
  clearInterval(id){
    if(this.intervals.has(id)){
      clearInterval(id);
      this.intervals.delete(id);
    }
  }
  
  cleanup(){
    const unbinders=[...this.unbinders];
    const timeouts=new Set(this.timeouts);
    const intervals=new Set(this.intervals);
    
    this.unbinders=[];
    this.timeouts.clear();
    this.intervals.clear();
    
    unbinders.forEach(off=>{try{off();}catch{}});
    timeouts.forEach(id=>{try{clearTimeout(id);}catch{}});
    intervals.forEach(id=>{try{clearInterval(id);}catch{}});
  }
}

// ===== Utils =====
const Utils={
  $:(selector)=>document.querySelector(selector),
  $$:(selector)=>Array.from(document.querySelectorAll(selector)),
  
  debounce(fn,delay=CONFIG.DEBOUNCE_DELAY){
    let timer;
    return(...args)=>{
      clearTimeout(timer);
      timer=setTimeout(()=>fn(...args),delay);
    };
  },
  
  throttle(fn,wait=CONFIG.THROTTLE_DELAY){
    let last=0,timer=null,lastArgs=null;
    return function throttled(...args){
      const now=Date.now();
      const remaining=wait-(now-last);
      lastArgs=args;
      if(remaining<=0){
        last=now;
        if(timer){
          clearTimeout(timer);
          timer=null;
        }
        return fn.apply(this,args);
      }
      if(!timer){
        timer=setTimeout(()=>{
          last=Date.now();
          timer=null;
          fn.apply(this,lastArgs);
        },remaining);
      }
    };
  },
  
  rafThrottle(fn){
    let ticking=false,lastArgs=null,ctx=null;
    return function(...args){
      lastArgs=args;
      ctx=this;
      if(!ticking){
        ticking=true;
        requestAnimationFrame(()=>{
          ticking=false;
          try{fn.apply(ctx,lastArgs);}catch{}
        });
      }
    };
  },
  
  numOrNull(value){
    const n=Number(value);
    return Number.isFinite(n)&&n!==0?n:null;
  },
  
  intOrNull(value){
    const n=parseInt(value,10);
    return Number.isFinite(n)&&n!==0?n:null;
  },
  
  scheduleIdleTask(fn,options={}){
    if('requestIdleCallback'in window)
      return requestIdleCallback(fn,{timeout:CONFIG.IDLE_TIMEOUT,...options});
    else
      return setTimeout(fn,0);
  },
  
  cancelIdleTask(id){
    if('cancelIdleCallback'in window)cancelIdleCallback(id);
    else clearTimeout(id);
  }
};

// ===== StorageManager - ✅ IndexedDB版本：更大容量更好性能 =====
class StorageManager{
  static _db=null;
  static _dbName='chatAppDB';
  static _dbVersion=1;
  static _storeName='chatData';
  static _queue=new Map();
  static _initPromise=null;
  
  static async init(){
    const box=Utils.$('#messages');
    if(box){
      const mo=new MutationObserver((muts)=>{
        for(const m of muts){ for(const n of m.addedNodes){ if(n.nodeType===1 && n.classList.contains('msg')) this.animateIn(n); }}
      });
      mo.observe(box,{childList:true});
    }
    if(this._db)return this._db;
    if(this._initPromise)return this._initPromise;
    
    this._initPromise=new Promise((resolve,reject)=>{
      const request=indexedDB.open(this._dbName,this._dbVersion);
      
      request.onerror=()=>reject(request.error);
      request.onsuccess=()=>{
        this._db=request.result;
        resolve(this._db);
      };
      
      request.onupgradeneeded=(e)=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains(this._storeName)){
          db.createObjectStore(this._storeName);
        }
      };
    });
    
    return this._initPromise;
  }
  
  static async load(key,fallback){
    try{
      await this.init();
      
      return new Promise((resolve)=>{
        const tx=this._db.transaction([this._storeName],'readonly');
        const store=tx.objectStore(this._storeName);
        const request=store.get(key);
        
        request.onsuccess=()=>{
          const value=request.result;
          resolve(value!==undefined?value:fallback);
        };
        
        request.onerror=()=>resolve(fallback);
      });
    }catch(e){
      console.error('IndexedDB load error:',e);
      return fallback;
    }
  }
  
  static async save(key,value){
    const existing=this._queue.get(key);
    if(existing)clearTimeout(existing.timer);
    
    return new Promise((resolve)=>{
      const timer=setTimeout(async()=>{
        try{
          await this._executeWrite(key,value);
          this._queue.delete(key);
          resolve();
        }catch(e){
          this._queue.delete(key);
          resolve(); // Still resolve to not block
        }
      },100);
      this._queue.set(key,{value,timer});
    });
  }
  
  static async _executeWrite(key,value){
    try{
      await this.init();
      
      return new Promise((resolve,reject)=>{
        const tx=this._db.transaction([this._storeName],'readwrite');
        const store=tx.objectStore(this._storeName);
        const request=store.put(value,key);
        
        request.onsuccess=()=>resolve(true);
        request.onerror=()=>reject(request.error);
      });
    }catch(e){
      console.error('IndexedDB write error:',e);
      if(e.name==='QuotaExceededError'){
        ErrorHandler.show('存储空间已满，请导出备份后清理数据',5000);
      }else{
        ErrorHandler.show('数据保存失败: '+e.message,4000);
      }
      return false;
    }
  }
  
  static async flush(){
    const promises=[];
    for(const[key,item]of this._queue){
      if(item.timer)clearTimeout(item.timer);
      promises.push(this._executeWrite(key,item.value));
    }
    this._queue.clear();
    return Promise.all(promises);
  }
}

// ===== ErrorHandler =====
class ErrorHandler{
  static show(message,duration=3000){
    const existing=document.querySelectorAll('.error-toast');
    if(existing.length>=3)return;
    
    const recentToasts=Array.from(existing).filter(t=>t.textContent===message);
    if(recentToasts.length>0)return;
    
    const toast=document.createElement('div');
    toast.className='error-toast';
    toast.textContent=message;
    document.body.appendChild(toast);
    
    setTimeout(()=>{
      toast.classList.add('hide');
      setTimeout(()=>toast.remove(),300);
    },duration);
  }
}

// ===== DOMManager - 添加self-heal =====
class DOMManager{
  constructor(){
    this.elements=new Map();
    this.updateQueue=[];
    this.isFlushScheduled=false;
    this.cleanupTimer=null;
    this.cachedElements={
      messages:null,
      input:null,
      send:null,
      sidebar:null,
      backdrop:null,
      btnSessions:null,
      btnSettings:null,
      btnNew:null,
      composerModelSelector:null,
      newChatModelSelector:null
    };
  }
  
  get(selector){
    let el=this.elements.get(selector);
    if(!el||!el.isConnected){
      el=Utils.$(selector);
      this.elements.set(selector,el);
    }
    return el;
  }
  
  // ✅ Self-heal: 自动重新查询断开的元素
  getCached(key){
    const el=this.cachedElements[key];
    if(!el||!el.isConnected){
      const selector=this._getSelectorForKey(key);
      const fresh=selector?Utils.$(selector):null;
      this.cachedElements[key]=fresh;
      return fresh;
    }
    return el;
  }
  
  _getSelectorForKey(key){
    const map={
      messages:'#messages',
      input:'#input',
      send:'#send',
      sidebar:'#sidebar',
      backdrop:'#backdrop',
      btnSessions:'#btnSessions',
      btnSettings:'#btnSettings',
      btnNew:'#btnNew',
      composerModelSelector:'#composerModelSelector',
      newChatModelSelector:'#newChatModelSelector'
    };
    return map[key];
  }
  
  invalidate(selector){
    this.elements.delete(selector);
  }
  
  batchUpdate(fn){
    this.updateQueue.push(fn);
    if(!this.isFlushScheduled){
      this.isFlushScheduled=true;
      queueMicrotask(()=>this.flushUpdates());
    }
  }
  
  flushUpdates(){
    this.updateQueue.forEach(fn=>{
      try{fn();}catch{}
    });
    this.updateQueue=[];
    this.isFlushScheduled=false;
  }
  
  cleanupDisconnected(){
    for(const[key,el]of this.elements.entries()){
      if(el&&!el.isConnected){
        this.elements.delete(key);
      }
    }
  }
  
  startAutoCleanup(){
    this.stopAutoCleanup();
    this.cleanupTimer=setInterval(()=>this.cleanupDisconnected(),60000);
  }
  
  stopAutoCleanup(){
    if(this.cleanupTimer){
      clearInterval(this.cleanupTimer);
      this.cleanupTimer=null;
    }
  }
  
  clear(){
    this.stopAutoCleanup();
    this.elements.clear();
    for(const key in this.cachedElements){
      this.cachedElements[key]=null;
    }
  }
}

// ===== StateManager =====
class StateManager{
  constructor(){
    this.state={
      modelPresets:[
        {enabled:true,name:'GPT-4',type:'openai',config:{
          base:'https://api.openai.com/v1',key:'',model:'gpt-4o-mini',
          temperature:null,top_p:null,max_tokens:null,stream:false
        }}
      ],
      sessions:{},
      currentId:null,
      promptPresets:{
        'default':{name:'默认预设',sysPrompt:'',firstUser:'',firstAssistant:'',
          messagePrefix:'',assistantPrefill:'',regexRules:[]}
      },
      currentModelIndex:0,
      editingPromptPreset:null
    };
    this.saveTimer=null;
    this.pendingSaves=new Set();
    this.initialized=false;
  }
  
  async init(){
    if(this.initialized)return;
    
    // 异步加载所有数据
    const [modelPresets,sessions,currentId,promptPresets]=await Promise.all([
      StorageManager.load(CONFIG.STORAGE_KEYS.modelPresets,this.state.modelPresets),
      StorageManager.load(CONFIG.STORAGE_KEYS.sessions,this.state.sessions),
      StorageManager.load(CONFIG.STORAGE_KEYS.currentId,this.state.currentId),
      StorageManager.load(CONFIG.STORAGE_KEYS.promptPresets,this.state.promptPresets)
    ]);
    
    this.state.modelPresets=modelPresets;
    this.state.sessions=sessions;
    this.state.currentId=currentId;
    this.state.promptPresets=promptPresets;
    
    this.initialized=true;
  }
  
  get(key){
    return this.state[key];
  }
  
  set(key,value){
    this.state[key]=value;
    this.pendingSaves.add(key);
    this.debounceSave();
  }
  
  debounceSave(){
    clearTimeout(this.saveTimer);
    this.saveTimer=setTimeout(()=>{
      for(const key of this.pendingSaves){
        const storageKey=CONFIG.STORAGE_KEYS[key];
        if(storageKey)StorageManager.save(storageKey,this.state[key]);
      }
      this.pendingSaves.clear();
    },CONFIG.PERSIST_DELAY);
  }
  
  forceSave(){
    clearTimeout(this.saveTimer);
    for(const key of this.pendingSaves){
      const storageKey=CONFIG.STORAGE_KEYS[key];
      if(storageKey)StorageManager.save(storageKey,this.state[key]);
    }
    this.pendingSaves.clear();
  }
  
  getActiveSession(){
    return this.state.sessions[this.state.currentId];
  }
  
  getActivePresets(){
    return this.state.modelPresets.filter(p=>p.enabled);
  }
  
  getCurrentPreset(){
    const presets=this.getActivePresets();
    return presets[this.state.currentModelIndex]||presets[0];
  }
  
  getCurrentPromptConfig(){
    // 返回default预设作为后备
    return this.state.promptPresets['default']||
      {sysPrompt:'',firstUser:'',firstAssistant:'',messagePrefix:'',assistantPrefill:'',regexRules:[]};
  }
  
  getSessionPromptConfig(session){
    if(!session)return this.getCurrentPromptConfig();
    const presetName=session.promptPresetName||'default';
    return this.state.promptPresets[presetName]||
      this.state.promptPresets['default']||
      {sysPrompt:'',firstUser:'',firstAssistant:'',messagePrefix:'',assistantPrefill:'',regexRules:[]};
  }
}

// ===== MessageWindowManager =====
class MessageWindowManager{
  constructor(){
    this.window={enabled:false,start:0,end:-1,total:0};
  }
  
  evaluate(total){
    if(total>CONFIG.MSG_VLIST_THRESHOLD){
      this.window.enabled=true;
      this.window.total=total;
      this.window.end=total-1;
      this.window.start=Math.max(0,total-CONFIG.MSG_WINDOW_TAIL-CONFIG.MSG_WINDOW_BUFFER);
    }else{
      this.window.enabled=false;
      this.window.total=total;
      this.window.start=0;
      this.window.end=total-1;
    }
  }
  
  loadEarlier(){
    if(!this.window.enabled||this.window.start===0)return null;
    const newStart=Math.max(0,this.window.start-CONFIG.MSG_LOAD_CHUNK);
    const oldStart=this.window.start;
    this.window.start=newStart;
    return{newStart,oldStart};
  }
  
  appendNew(total,isNearBottom=true){
    if(this.window.enabled){
      this.window.total=total;
      this.window.end=total-1;
      if(isNearBottom){
        this.window.start=Math.max(0,total-CONFIG.MSG_WINDOW_TAIL-CONFIG.MSG_WINDOW_BUFFER);
      }
    }else{
      this.window.total=total;
      this.window.end=total-1;
    }
  }
}

// ===== APIManager =====
class APIManager{
  constructor(state){
    this.state=state;
    this.abortController=null;
  }
  
  buildMessages(session){
    const msgs=[];
    const pc=this.state.getSessionPromptConfig(session);
    
    if(pc.sysPrompt)msgs.push({role:'system',content:pc.sysPrompt});
    if(pc.firstUser)msgs.push({role:'user',content:pc.firstUser});
    
    const history=session.history||[];
    history.forEach((m,i)=>{
      if(m.role==='user'||m.role==='assistant'){
        const isLastUser=m.role==='user'&&i===history.length-1;
        const content=(isLastUser&&pc.messagePrefix)?pc.messagePrefix+m.content:m.content;
        msgs.push({role:m.role,content});
      }
    });
    
    if(pc.assistantPrefill)msgs.push({role:'assistant',content:pc.assistantPrefill});
    
    return msgs;
  }
  
  async send(session,onDelta){
    const preset=this.state.getCurrentPreset();
    if(!preset)throw new Error('无可用模型预设');
    
    this.abortController=new AbortController();
    const signal=this.abortController.signal;
    
    if(preset.type==='openai'){
      return await this.sendOpenAI(session,preset.config,onDelta,signal);
    }else{
      return await this.sendGemini(session,preset.config,preset.type==='gemini-proxy',onDelta,signal);
    }
  }
  
  async sendOpenAI(session,cfg,onDelta,signal){
    const url=(cfg.base||'https://api.openai.com/v1').replace(/\/+$/,'')+'/chat/completions';
    const body={
      model:cfg.model||'gpt-4o-mini',
      messages:this.buildMessages(session),
      stream:!!cfg.stream
    };
    
    if(cfg.temperature!=null)body.temperature=cfg.temperature;
    if(cfg.top_p!=null)body.top_p=cfg.top_p;
    if(cfg.max_tokens!=null)body.max_tokens=cfg.max_tokens;
    
    // ✅ 添加思维链支持 - 只有在启用时才发送
    if(cfg.useThinking&&cfg.thinkingEffort){
      body.reasoning_effort=cfg.thinkingEffort;
    }else if(cfg.useThinking){
      // 启用但未指定级别，使用medium作为默认值
      body.reasoning_effort='medium';
    }
    
    const res=await fetch(url,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${cfg.key}`
      },
      body:JSON.stringify(body),
      signal
    });
    
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    
    if(cfg.stream){
      const reader=res.body.getReader();
      const decoder=new TextDecoder();
      let buffer='',full='',thinking='';
      
      while(true){
        const{done,value}=await reader.read();
        if(done)break;
        buffer+=decoder.decode(value,{stream:true});
        const lines=buffer.split('\n');
        buffer=lines.pop()||'';
        
        for(const raw of lines){
          const line=raw.trim();
          if(!line.startsWith('data:'))continue;
          const data=line.slice(5).trim();
          if(data==='[DONE]')continue;
          
          try{
            const json=JSON.parse(data);
            const delta=json?.choices?.[0]?.delta?.content||'';
            const thinkDelta=json?.choices?.[0]?.delta?.reasoning_content||'';
            if(thinkDelta)thinking+=thinkDelta;
            if(delta){
              full+=delta;
              onDelta&&onDelta(full,thinking);
            }
          }catch{}
        }
      }
      return{content:full||'(空响应)',thinking};
    }else{
      const data=await res.json();
      const content=data?.choices?.[0]?.message?.content||'(空响应)';
      const thinking=data?.choices?.[0]?.message?.reasoning_content||'';
      return{content,thinking};
    }
  }
  
  async sendGemini(session,cfg,isProxy,onDelta,signal){
    const base=isProxy?
      (cfg.proxyUrl||'http://127.0.0.1:8889').replace(/\/+$/,''):
      (cfg.base||'https://generativelanguage.googleapis.com').replace(/\/+$/,'');
    
    const model=cfg.model||'gemini-2.5-flash';
    const action = cfg.stream ? 'streamGenerateContent' : 'generateContent';
let url = `${base}/v1beta/models/${encodeURIComponent(model)}:${action}`;
const qs = [];
if (cfg.stream) qs.push('alt=sse');
if (!isProxy && cfg.key) qs.push(`key=${encodeURIComponent(cfg.key)}`);
if (qs.length) url += `?${qs.join('&')}`;
    
    const contents=[];
    const pc=this.state.getSessionPromptConfig(session);
    
    if(pc.firstUser)contents.push({role:'user',parts:[{text:pc.firstUser}]});
    
    const history=session.history||[];
    history.forEach((m,i)=>{
      const isLastUser=m.role==='user'&&i===history.length-1;
      const content=(isLastUser&&pc.messagePrefix)?pc.messagePrefix+m.content:m.content;
      
      if(m.role==='assistant')contents.push({role:'model',parts:[{text:m.content}]});
      if(m.role==='user')contents.push({role:'user',parts:[{text:content}]});
    });
    
    if(pc.assistantPrefill)contents.push({role:'model',parts:[{text:pc.assistantPrefill}]});
    
    const generationConfig={};
    if(cfg.temperature!=null)generationConfig.temperature=cfg.temperature;
    if(cfg.top_p!=null)generationConfig.topP=cfg.top_p;
    if(cfg.top_k!=null)generationConfig.topK=cfg.top_k;
    if(cfg.max_output_tokens!=null)generationConfig.maxOutputTokens=cfg.max_output_tokens;
    
    // ✅ 添加思维链支持 - 根据官方文档格式
    if(cfg.useThinking){
      // thinkingBudget: -1=自动(动态), 0=禁用, 1-24576=指定token数
      const budget=cfg.thinkingBudget!=null?cfg.thinkingBudget:-1;
      generationConfig.thinkingConfig={
        thinkingBudget:budget,
        includeThoughts:true
      };
    }
    
    // ✅ 构建请求体 - 按照官方文档推荐的字段顺序
    const body={
      contents
    };
    
    // systemInstruction 应该在 contents 之后
    if(pc.sysPrompt){
      body.systemInstruction={
        parts:[{text:pc.sysPrompt}]
      };
    }
    
    // safetySettings
    body.safetySettings=['HARM_CATEGORY_HARASSMENT','HARM_CATEGORY_HATE_SPEECH',
      'HARM_CATEGORY_SEXUALLY_EXPLICIT','HARM_CATEGORY_DANGEROUS_CONTENT']
      .map(category=>({category,threshold:'OFF'}));
    
    // generationConfig 放在最后
    body.generationConfig=generationConfig;
    
    const headers = {'Content-Type':'application/json', ...(cfg.stream?{'Accept':'text/event-stream'}:{})};
if (!isProxy && cfg.key) headers['X-Goog-Api-Key'] = cfg.key;
if (isProxy && cfg.proxyPass) headers.Authorization = `Bearer ${cfg.proxyPass}`;
    
    const res=await fetch(url,{
      method:'POST',
      headers,
      body:JSON.stringify(body),
      signal
    });
    
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    
    if(cfg.stream){
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let pending = '', eventData = '', full = '', thinking = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        pending += decoder.decode(value, { stream: true });
        let idx;
        while ((idx = pending.indexOf('\n')) !== -1) {
          const line = pending.slice(0, idx).trimEnd();
          pending = pending.slice(idx + 1);
          if (line === '') {
            if (eventData) {
              try {
                const obj = JSON.parse(eventData);
                const parts = obj?.candidates?.[0]?.content?.parts || [];
                for (const p of parts) {
                  if (p.thought) thinking += p.text || '';
                  else if (p.text) full += p.text;
                }
                if (onDelta) onDelta(full, thinking, obj.usageMetadata);
              } catch {}
              eventData = '';
            }
            continue;
          }
          if (line.startsWith('data:')) eventData += line.slice(5).trim() + '\n';
        }
      }
      return { content: full || '(空响应)', thinking };
    }else{
      const data=await res.json();
      const parts=data?.candidates?.[0]?.content?.parts||[];
      let content='',thinking='';
      for(const part of parts){
        if(part.thought){
          thinking+=part.text||'';
        }else if(part.text){
          content+=part.text;
        }
      }
      return{content:content||'(空响应)',thinking};
    }
  }
  
  abort(){
    if(this.abortController){
      try{this.abortController.abort();}catch{}
    }
  }
}

// ===== UIManager - 核心改进 =====
class UIManager{

  
  ensureBottom(retries=2, delay=120){
    const box=Utils.$('#messages'); if(!box) return;
    const stick=()=>{ try{ box.scrollTop = box.scrollHeight; }catch(_){} };
    requestAnimationFrame(()=>{
      stick();
      requestAnimationFrame(()=>{ stick(); });
    });
    if(retries>0){
      setTimeout(()=>this.ensureBottom(retries-1, delay), delay);
    }
  }
/* Release suppressed auto-stick and optionally scroll to bottom once */
  _releaseAutoStick(){
    const box=Utils.$('#messages');
    const doStick = this._pendingStick;
    this._suppressAutoStick=false;
    this._pendingStick=false;
    if(doStick && box){
      requestAnimationFrame(()=>{ box.scrollTop = box.scrollHeight; });
    }
  }

  constructor(state,api){
    this.state=state;
    this._suppressAutoStick=false;
    this._pendingStick=false;
    this._vvAvailable=typeof window!=='undefined' && window.visualViewport;
    this._vpFrozen=false;
    this._vvListener=null;
    this._unfreezeTimer=null;
    this.api=api;
    this.dom=new DOMManager();
    this.events=new EventHub();
    this.sanitizer=new SmartSanitizer();
    this.domDiffer=new DOMDiffer();
    this.domPool=new DOMPool();
    this.regexProcessor=new RegexProcessor();
    this.observerMgr=new LeakSafeObserverManager();
    this.windowManager=new MessageWindowManager();
    
    // ✅ 核心改进1：维护idx到element的映射
    this.messageElements=new Map();
    
    // ✅ 核心改进2：缓存typing的body元素
    this.typingBodyCache=null;
    
    // ✅ 核心改进3：批量更新
    this.pendingUpdates=new Set();
    this.updateScheduled=false;
    
    // ✅ 编辑状态跟踪
    this.editingState=null;  // {msgId, originalContent}
    
    this.isSending=false;
    this.typingElement=null;
    this._scrollRAF=null;
    this._settingsRendered=false;
    this.isLoadingEarlier=false;
    this._regexInputDebounced=null;
    
    window._sanitizer=this.sanitizer;
  }

  /* === Motion & Scroll helpers (added) === */
  animateIn(el){
    if(!el) return;
    el.classList.add('is-entering');
    requestAnimationFrame(()=>{
      el.classList.add('is-active');
      const done=()=>{
        el.classList.remove('is-entering','is-active');
        el.removeEventListener('transitionend',done);
      };
      el.addEventListener('transitionend',done);
      setTimeout(done, 320); // fallback
    });
  }
  animateOut(el){
    return new Promise(res=>{
      if(!el) return res();
      el.classList.add('is-exiting');
      const done=()=>{ el.removeEventListener('transitionend',done); res(); };
      el.addEventListener('transitionend',done);
      setTimeout(done, 280);
    });
  }
  preserveScroll(fn){
    const box=Utils.$('#messages');
    if(!box){ fn&&fn(); return; }
    const gap = box.scrollHeight - box.scrollTop - box.clientHeight;
    fn&&fn();
    requestAnimationFrame(()=>{
      box.scrollTop = Math.max(0, box.scrollHeight - box.clientHeight - gap);
    });
  }
  renumberMessagesFrom(startIdx=0){
    const session=this.state.getActiveSession();
    const history=session?.history||[];
    for(let i=startIdx;i<history.length;i++){
      const msg=history[i];
      const el=this.messageElements.get(msg.id);
      if(!el)continue;
      const pill=el.querySelector('header .pill');
      if(pill)pill.textContent = '#'+(i+1);
    }
  }

  /* === Viewport freeze to avoid IME-dismiss flicker on mobile === */
  freezeViewport(){
    try{
      if(!this._vvAvailable||this._vpFrozen) return;
      this._vpFrozen=true;
      const h=Math.round(window.innerHeight||document.documentElement.clientHeight);
      document.documentElement.style.setProperty('--vp-lock-h', h+'px');
      document.body.classList.add('vp-freeze');
      let last=performance.now();
      const onVV=()=>{ last=performance.now(); };
      this._vvListener=onVV;
      try{ visualViewport.addEventListener('resize', onVV, {passive:true}); }catch{}
      const poll=()=>{
        if(!this._vpFrozen) return;
        const elapsed=performance.now()-last;
        if(elapsed>150){ this.unfreezeViewport(); }
        else{ this._unfreezeTimer=setTimeout(poll,100); }
      };
      this._unfreezeTimer=setTimeout(poll, 160);
    }catch{}
  }
  unfreezeViewport(){
    try{
      if(!this._vpFrozen) return;
      this._vpFrozen=false;
      document.body.classList.remove('vp-freeze');
      document.documentElement.style.removeProperty('--vp-lock-h');
      if(this._vvListener){
        try{ visualViewport.removeEventListener('resize', this._vvListener); }catch{}
        this._vvListener=null;
      }
      if(this._unfreezeTimer){ clearTimeout(this._unfreezeTimer); this._unfreezeTimer=null; }
      try{ this._releaseAutoStick(); }catch{}
    }catch{}
  }




  
  async init(){
    // 自动动效：对新加入的消息元素添加入场动画
    const __boxMOBox=Utils.$('#messages');
    if(__boxMOBox && !this._moSetup){
      this._moSetup=true;
      const __mo=new MutationObserver((muts)=>{
        for(const m of muts){
          for(const n of m.addedNodes){
            if(n && n.nodeType===1 && n.classList && n.classList.contains('msg')) this.animateIn(n);
          }
        }
      });
      __mo.observe(__boxMOBox,{childList:true});
    }

    // 等待状态初始化完成
    await this.state.init();
    
    this.ensureSession();
    this.renderMessages(true);
    this.renderSidebar();
    this.updateModelSelectors();
    this.bindEvents();
    this.setupTopObserver();
    if(this._setupIMEHandlers) this._setupIMEHandlers();
    if(this._updateBottomPadding) this._updateBottomPadding();
    this.dom.startAutoCleanup();
  }
  
  ensureSession(){
    if(!this.state.get('currentId')||!this.state.getActiveSession()){
      this.createNewSession();
    }
  }
  
  createNewSession(presetKey='default'){
    // ✅ 切换会话前自动保存正在编辑的消息
    this.autoSaveEditingMessage();
    
    const id='s'+Date.now()+'_'+Math.random().toString(36).slice(2,9);
    const sessions={...this.state.get('sessions')};
    const pc=this.state.get('promptPresets')[presetKey]||this.state.getCurrentPromptConfig();
    const preset=this.state.getCurrentPreset();
    
    sessions[id]={
      name:`对话 ${Object.keys(sessions).length+1}`,
      modelName:preset?.name||'未知',
      promptPresetName:presetKey,
      history:pc.firstAssistant?[{
        id:`msg_${Date.now()}_init`,
        role:'assistant',
        content:pc.firstAssistant,
        modelName:preset?.name
      }]:[]
    };
    
    this.state.set('sessions',sessions);
    this.state.set('currentId',id);
    this.clearMessages();
    this.renderMessages(true);
    this.renderSidebar();
  }
  
  showPresetSelector(){
    this.renderPresetSelector();
    Utils.$('#dlgSelectPreset')?.showModal();
  }
  
  // ✅ 清理消息映射
  clearMessages(){
    // ✅ 清理前自动保存正在编辑的消息
    this.autoSaveEditingMessage();
    
    for(let[msgId,el]of this.messageElements){
      el.remove();
      this.domPool.release('article',el);
    }
    this.messageElements.clear();
  }
  
  renderPresetSelector(){
    const grid=Utils.$('#presetSelectGrid');
    if(!grid)return;
    
    const presets=this.state.get('promptPresets');
    const fragment=document.createDocumentFragment();
    
    // 预设图标映射
    const icons={
      'default':'💬',
      'creative':'🎨',
      'technical':'⚙️',
      'business':'💼',
      'casual':'☕'
    };
    
    Object.keys(presets).sort().forEach(key=>{
      const preset=presets[key];
      const card=document.createElement('div');
      card.className='preset-card';
      card.dataset.presetKey=key;
      
      const icon=icons[key]||'📝';
      const description=preset.firstUser||preset.firstAssistant||preset.sysPrompt||'暂无描述';
      const descShort=description.slice(0,80)+(description.length>80?'...':'');
      
      card.innerHTML=`
        <div class="preset-card-icon">${icon}</div>
        <div class="preset-card-name">${preset.name}</div>
        <div class="preset-card-desc">${descShort}</div>
        <div class="preset-card-footer">
          <span>${preset.regexRules?.length||0}个规则</span>
          <span>→</span>
        </div>
      `;
      
      fragment.appendChild(card);
    });
    
    grid.innerHTML='';
    grid.appendChild(fragment);
  }
  
  // ✅ 核心改进：使用Map而不是querySelectorAll
  renderMessages(scrollToBottom=false){
    const session=this.state.getActiveSession();
    const box=Utils.$('#messages');
    if(!session||!box)return;
    
    const history=session.history||[];
    const total=history.length;
    this.windowManager.evaluate(total);
    
    const win=this.windowManager.window;
    
    // ✅ 移除窗口外的元素 - 使用msgId遍历
    const toRemove=[];
    for(let[msgId,el]of this.messageElements){
      // Find the index of this message in current history
      const msgIdx=history.findIndex(m=>m.id===msgId);
      if(msgIdx===-1||msgIdx<win.start||msgIdx>win.end){
        toRemove.push({msgId,el});
      }
    }
    
    const prevScrollHeight=box.scrollHeight;
    const prevScrollTop=box.scrollTop;
    
    // ✅ 检查要移除的消息中是否有正在编辑的
    if(this.editingState){
      const isEditingBeingRemoved=toRemove.some(({msgId})=>msgId===this.editingState.msgId);
      if(isEditingBeingRemoved){
        this.autoSaveEditingMessage();
      }
    }
    
    toRemove.forEach(({msgId,el})=>{
      this.domPool.release('article',el);
      el.remove();
      this.messageElements.delete(msgId);
    });
    
    const scrollAdjust=prevScrollHeight-box.scrollHeight;
    if(scrollAdjust>0&&!scrollToBottom){
      box.scrollTop=Math.max(0,prevScrollTop-scrollAdjust);
    }
    
    // 添加新元素 - 使用msgId检查是否已存在
    const fragment=document.createDocumentFragment();
    const __addedEls=[];
    for(let i=win.start;i<=win.end;i++){
      const msg=history[i];
      if(msg&&!this.messageElements.has(msg.id)){
        const el=this.buildMessageElement(msg,i);
        this.messageElements.set(msg.id,el);
        fragment.appendChild(el);
        __addedEls.push(el);
      }
    }
    
    if(fragment.childNodes.length){
      box.appendChild(fragment);
      __addedEls.forEach(el=>this.animateIn(el));
    }
    
    this.updateLoadTip(box,win);
    
    if(scrollToBottom){ if(!this._suppressAutoStick){ requestAnimationFrame(()=>{ box.scrollTop=box.scrollHeight; }); this.ensureBottom(1, 140); } else { this._pendingStick=true; } }
  }
  
  // ✅ 核心改进：复用子元素而不是重建
  buildMessageElement(msg,idx){
    const el=this.domPool.acquire('article',`msg ${msg.role}`);
    
    // 查找或创建子元素
    let header=el.querySelector('header');
    if(!header){
      header=document.createElement('header');
      el.appendChild(header);
    }
    
    let body=el.querySelector('.body');
    if(!body){
      body=document.createElement('div');
      body.className='body';
      el.appendChild(body);
    }
    
    let footer=el.querySelector('footer');
    if(!footer){
      footer=document.createElement('footer');
      el.appendChild(footer);
    }
    
    footer.style.display=''; footer.hidden=false; footer.removeAttribute('style');
// 更新内容
    const badge=msg.role==='assistant'&&msg.modelName?
      `<span class="model-badge">${msg.modelName}</span>`:'';
    
    header.innerHTML=`<div class="role">${msg.role.toUpperCase()} ${badge}</div><div class="pill">#${idx+1}</div>`;
    
    body.dataset.msgId=msg.id;
    
    // ✅ 性能优化：使用DocumentFragment批量更新DOM
    const fragment=document.createDocumentFragment();
    
    // 添加思维链显示
    if(msg.thinking&&msg.thinking.trim()){
      const thinkingText=this.sanitizer.sanitize(msg.thinking);
      const details=document.createElement('details');
      details.style.cssText='margin-bottom:0.75rem;border:1px solid var(--border);border-radius:0.5rem;background:rgba(96,165,250,0.05);padding:0.75rem';
      
      const summary=document.createElement('summary');
      summary.style.cssText='cursor:pointer;font-weight:600;font-size:13px;color:var(--accent2);user-select:none;display:flex;align-items:center;gap:0.5rem';
      summary.innerHTML=`<span>💭 思维链</span><span style="font-size:11px;color:var(--muted);font-weight:normal">(${msg.thinking.length}字)</span>`;
      
      const content=document.createElement('div');
      content.style.cssText='margin-top:0.75rem;padding:0.75rem;font-size:13px;color:var(--fg);line-height:1.7;white-space:pre-wrap;border-top:1px solid var(--border)';
      content.innerHTML=thinkingText;
      
      details.appendChild(summary);
      details.appendChild(content);
      fragment.appendChild(details);
    }
    
    // 添加消息内容
    const contentDiv=document.createElement('div');
    contentDiv.innerHTML=this.sanitizer.sanitize(msg.content||'');
    fragment.appendChild(contentDiv);
    
    body.innerHTML='';
    body.appendChild(fragment);
    
    footer.innerHTML=`<button class="btn small" data-act="edit" data-msg-id="${msg.id}">编辑</button>${
      msg.role==='assistant'?`<button class="btn small" data-act="regen" data-msg-id="${msg.id}">重新生成</button>`:''
    }<button class="btn small warn" data-act="del" data-msg-id="${msg.id}">删除</button>`;
    
    el.dataset.msgId=msg.id;
    return el;
  }
  
  updateLoadTip(box,win){
    const needTip=win.enabled&&win.start>0;
    let tipEl=box.querySelector('.load-older');
    
    if(needTip){
      if(!tipEl){
        tipEl=document.createElement('div');
        tipEl.className='load-older';
        box.insertBefore(tipEl,box.firstChild);
      }
      
      tipEl.innerHTML=`<div class="info">共 ${win.total} 条,已折叠 ${win.start} 条更早消息</div><button class="btn small" id="btnLoadEarlier">加载更早消息</button>`;
      
      const btn=tipEl.querySelector('#btnLoadEarlier');
      if(btn)btn.onclick=()=>this.loadEarlierMessages();
    }else if(tipEl){
      tipEl.remove();
    }
  }
  
  loadEarlierMessages(){
    if(this.isLoadingEarlier)return;
    this.isLoadingEarlier=true;
    
    const session=this.state.getActiveSession();
    const box=Utils.$('#messages');
    if(!session||!box){
      this.isLoadingEarlier=false;
      return;
    }
    
    const info=this.windowManager.loadEarlier();
    if(!info){
      this.isLoadingEarlier=false;
      return;
    }
    
    const{newStart,oldStart}=info;
    const history=session.history;
    
    const prevHeight=box.scrollHeight;
    const prevTop=box.scrollTop;
    
    const fragment=document.createDocumentFragment();
    for(let i=newStart;i<oldStart;i++){
      const msg=history[i];
      if(msg&&!this.messageElements.has(msg.id)){
        const el=this.buildMessageElement(msg,i);
        this.messageElements.set(msg.id,el);
        fragment.appendChild(el);
      }
    }
    
    const tip=box.querySelector('.load-older');
    const anchor=tip?tip.nextElementSibling:box.firstChild;
    box.insertBefore(fragment,anchor);
    
    if(tip){
      tip.querySelector('.info').textContent=`共 ${history.length} 条,已折叠 ${newStart} 条更早消息`;
    }
    
    const delta=box.scrollHeight-prevHeight;
    box.scrollTop=prevTop+delta;
    
    this.isLoadingEarlier=false;
  }
  
  setupTopObserver(){
    const box=Utils.$('#messages');
    if(!box||!('IntersectionObserver'in window))return;
    
    let sentinel=box.querySelector('.top-sentinel');
    if(!sentinel){
      sentinel=document.createElement('div');
      sentinel.className='top-sentinel sentinel';
    }
    
    this.observerMgr.cleanup('message-top');
    const observer=this.observerMgr.create('message-top',box,(entry)=>{
      if(!entry.isIntersecting)return;
      
      const win=this.windowManager.window;
      if(!win.enabled||win.start<=0||this.isLoadingEarlier)return;
      
      this.loadEarlierMessages();
      
      const tip=box.querySelector('.load-older');
      const anchor=tip?tip.nextElementSibling:box.firstChild;
      if(sentinel.nextSibling!==anchor&&anchor){
        box.insertBefore(sentinel,anchor);
      }
    },{threshold:0,rootMargin:'50px'});
    
    const tip=box.querySelector('.load-older');
    const anchor=tip?tip.nextElementSibling:box.firstChild;
    if(anchor){
      box.insertBefore(sentinel,anchor);
    }else{
      box.insertBefore(sentinel,box.firstChild);
    }
    
    this.observerMgr.observe('message-top',sentinel);
  }
  
  // ✅ 核心改进：批量更新
  appendMessage(msg){
    const session=this.state.getActiveSession();
    if(!session)return;
    
    if(!msg.id)msg.id=`msg_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
    session.history.push(msg);
    
    this.pendingUpdates.add(msg.id);
    this.scheduleUpdate();
  }
  
  scheduleUpdate(){
    if(this.updateScheduled)return;
    this.updateScheduled=true;
    
    requestAnimationFrame(()=>{
      this.flushUpdates();
      this.updateScheduled=false;
    });
  }
  
  flushUpdates(){
    if(this.pendingUpdates.size===0)return;
    
    const session=this.state.getActiveSession();
    if(!session)return;
    
    const history=session.history;
    const total=history.length;
    const box=Utils.$('#messages');
    if(!box)return;
    
    const isNearBottom=this.isNearBottom(box);
    this.windowManager.appendNew(total,isNearBottom);
    
    const win=this.windowManager.window;
    const fragment=document.createDocumentFragment();
    const __addedEls=[];
    
    for(let msgId of this.pendingUpdates){
      const msg=history.find(m=>m.id===msgId);
      if(!msg)continue;
      
      const idx=history.indexOf(msg);
      if(idx>=win.start&&idx<=win.end&&!this.messageElements.has(msgId)){
        const el=this.buildMessageElement(msg,idx);
        this.messageElements.set(msgId,el);
        fragment.appendChild(el);
        __addedEls.push(el);
      }
    }
    
    if(fragment.childNodes.length){
      box.appendChild(fragment);
      __addedEls.forEach(el=>this.animateIn(el));
      
      if(isNearBottom && !this._suppressAutoStick){
        requestAnimationFrame(()=>{ box.scrollTop=box.scrollHeight; });
      }else if(isNearBottom){
        this._pendingStick=true;
      }
    }
    
    this.updateLoadTip(box,win);
    this.pendingUpdates.clear();
  }
  
  renderSidebar(){
    Utils.scheduleIdleTask(()=>{
      this._doRefreshSidebar();
    });
  }
  
  _doRefreshSidebar(){
    const list=Utils.$('#sessionList');
    if(!list)return;
    
    const fragment=document.createDocumentFragment();
    const sessions=this.state.get('sessions');
    const currentId=this.state.get('currentId');
    
    Object.entries(sessions).forEach(([id,session])=>{
      const div=document.createElement('div');
      div.className='session'+(id===currentId?' active':'');
      div.dataset.id=id;
      
      const promptPresets=this.state.get('promptPresets');
      const promptPresetName=session.promptPresetName||'default';
      const promptPreset=promptPresets[promptPresetName];
      const promptDisplayName=promptPreset?promptPreset.name:'默认';
      
      div.innerHTML=`<div class="name" style="cursor:pointer;display:flex;align-items:center;gap:.5rem" data-act="rename-session" data-session-id="${id}">${session.name}<span style="font-size:10px;color:var(--muted);opacity:0.6">✎</span></div><div class="sub"><span class="pill">${session.modelName||'未知'}</span><span style="font-size:10px;color:var(--muted)">提示词:${promptDisplayName}</span></div><div class="actions"><button class="btn small" data-open="${id}">打开</button><button class="btn small warn" data-del="${id}">删除</button></div>`;
      
      fragment.appendChild(div);
    });
    
    this.dom.batchUpdate(()=>{
      list.innerHTML='';
      list.appendChild(fragment);
    });
  }
  
  updateModelSelectors(){
    const presets=this.state.getActivePresets();
    const currentIndex=this.state.get('currentModelIndex');
    
    [Utils.$('#composerModelSelector'),Utils.$('#newChatModelSelector')].forEach(selector=>{
      if(!selector)return;
      
      if(presets.length<=1){
        selector.style.display='none';
        return;
      }
      
      selector.style.display='flex';
      selector.innerHTML='';
      
      presets.forEach((preset,i)=>{
        const btn=document.createElement('button');
        btn.dataset.index=i;
        btn.textContent=preset.name;
        if(i===currentIndex)btn.classList.add('active');
        selector.appendChild(btn);
      });
    });
  }
  
  async sendMessage(){
    if(this.isSending){
      ErrorHandler.show('请等待当前消息发送完成');
      return;
    }
    
    if(this.isMessageEditing()){
      ErrorHandler.show('请先完成或取消正在进行的编辑');
      return;
    }
    
    // ✅ Immediately set flag to prevent race condition
    this.isSending=true;
    this.setSending(true);
    
    const session=this.state.getActiveSession();
    const input=Utils.$('#input');
    if(!session||!input){
      this.isSending=false;
      this.setSending(false);
      return;
    }
    
    const text=input.value.trim();
    if(!text&&session.history.length===0){
      this.isSending=false;
      this.setSending(false);
      return;
    }
    
    this._suppressAutoStick=true; this._pendingStick=false;
    if(text){
      if(this._vvAvailable) this.freezeViewport();
      this.appendMessage({role:'user',content:text});
      if (typeof this.flushUpdates === 'function') this.flushUpdates();
input.value='';
      this.state.set('sessions',this.state.get('sessions'));
    }
    
    const preset=this.state.getCurrentPreset();
    if(!preset){
      ErrorHandler.show('请先配置至少一个模型预设');
      this.isSending=false;
      this.setSending(false);
      return;
    }
    
    const promptPreset=this.state.getSessionPromptConfig(session);
    const isStream=preset?.config?.stream;
    
    let typing=null; let __typingStart=0; let __typingTimer=null;
    let partial='',partialThinking='';
    const TYPING_DELAY=90;
    __typingTimer=setTimeout(()=>{ typing=this.addTyping(isStream); __typingStart=performance.now(); }, TYPING_DELAY);
    const batcher=isStream?new AdaptiveStreamBatcher((text,thinking)=>{
      if(typing) this.updateTyping(typing,text,thinking);
    }):null;
    
    try{
      const result=await this.api.send(session,(text,thinking)=>{
        partial=text;
        partialThinking=thinking||'';
        if(batcher)batcher.push(text,thinking);
        else this.updateTyping(typing,text,thinking);
      });
      
      if(batcher)batcher.stop();
      if(__typingTimer){ clearTimeout(__typingTimer); __typingTimer=null; }
      if(typing){ const __delay=Math.max(0,240-(performance.now()-__typingStart)); setTimeout(()=>this.removeTyping(typing), __delay);}
      
      // ✅ 处理返回的content和thinking
      const content=typeof result==='string'?result:result.content;
      const thinking=typeof result==='object'?result.thinking:'';
      
      // ✅ 只在流式完成后应用正则
      let finalContent=content;
      if(promptPreset.regexRules&&promptPreset.regexRules.length>0){
        const compiledRules=this.regexProcessor.compileRules(promptPreset.regexRules);
        if(compiledRules){
          finalContent=this.regexProcessor.process(content,compiledRules);
        }
      }
      
      (function(){ try{ if (this.typingElement) this.typingElement.removeAttribute('data-streaming'); }catch(_){} }).call(this);
this.appendMessage({
        role:'assistant',
        content:finalContent,
        thinking:thinking||'',
        modelName:preset?.name
      });
      
      this.state.set('sessions',this.state.get('sessions'));
    }catch(error){
      if(batcher)batcher.stop();
      if(__typingTimer){ clearTimeout(__typingTimer); __typingTimer=null; }
      if(typing){ const __delay=Math.max(0,240-(performance.now()-__typingStart)); setTimeout(()=>this.removeTyping(typing), __delay);}
      
      const isAbort=error?.name==='AbortError';
      if(isAbort&&isStream&&partial){
        let finalPartial=partial;
        if(promptPreset.regexRules&&promptPreset.regexRules.length>0){
          const compiledRules=this.regexProcessor.compileRules(promptPreset.regexRules);
          if(compiledRules){
            finalPartial=this.regexProcessor.process(partial,compiledRules);
          }
        }
        (function(){ try{ if (this.typingElement) this.typingElement.removeAttribute('data-streaming'); }catch(_){} }).call(this);
this.appendMessage({
          role:'assistant',
          content:finalPartial,
          thinking:partialThinking||'',
          modelName:preset?.name
        });
      }else if(!isAbort){
        (function(){ try{ if (this.typingElement) this.typingElement.removeAttribute('data-streaming'); }catch(_){} }).call(this);
this.appendMessage({
          role:'assistant',
          content:`【错误】${error.message}`,
          modelName:preset?.name
        });
        ErrorHandler.show('API调用失败: '+error.message);
      }
      
      this.state.set('sessions',this.state.get('sessions'));
    }finally{
      setTimeout(()=>{ try{ this._releaseAutoStick(); }catch{} }, 240);
      if(this._vvAvailable) setTimeout(()=>this.unfreezeViewport(), 200);
      this.isSending=false;
      this.setSending(false);
    }
  }
  
  // ✅ 核心改进：缓存typing body
  addTyping(isStreaming){
    const box=Utils.$('#messages');
    if(!box)return null;
    
    const el=this.domPool.acquire('article','msg assistant');
    el.innerHTML=isStreaming?
      '<header><div class="role">ASSISTANT</div><div class="pill">回复中...</div></header><div class="body"><span class="typing-cursor"></span></div><footer style="display:none"></footer>':
      '<header><div class="role">ASSISTANT</div><div class="pill">思考中</div></header><div class="body"><span data-stream-prefix></span><span data-stream-tail></span></div><footer style="display:none"></footer>';
    
    requestAnimationFrame(()=>{
  this.dom.batchUpdate(()=>{
box.appendChild(el);
      if(this.isNearBottom(box))box.scrollTop=box.scrollHeight;
    
  });
});
    
    this.typingElement=el;
    this.typingBodyCache=el.querySelector('.body');  // ✅ 缓存body元素
    return el;
  }
  
  updateTyping(el,text,thinking){
    if(!el)return;
    
    const box=Utils.$('#messages');
    const shouldStick=box?this.isNearBottom(box):false;
    
    // ✅ 使用缓存的body元素
    const body=this.typingBodyCache;
    if(body){
      // ✅ 性能优化：只在thinking变化时重建details元素
      const existingDetails=body.querySelector('details');
      
      if(thinking){
        if(!existingDetails){
          // 首次添加思维链
          const details=document.createElement('details');
          details.style.cssText='margin-top:0.75rem;border:1px solid var(--border);border-radius:0.5rem;background:rgba(96,165,250,0.05);padding:0.5rem';
          details.setAttribute('data-thinking','true');
          
          const summary=document.createElement('summary');
          summary.style.cssText='cursor:pointer;font-weight:600;font-size:12px;color:var(--accent2);user-select:none';
          summary.textContent='💭 思维链 (点击展开)';
          
          const content=document.createElement('div');
          content.style.cssText='margin-top:0.5rem;padding:0.5rem;font-size:13px;color:var(--muted);line-height:1.6;white-space:pre-wrap';
          content.className='thinking-content';
          content.innerHTML=this.sanitizer.sanitize(thinking,true,el);
          
          details.appendChild(summary);
          details.appendChild(content);
          body.insertBefore(details,body.firstChild);
        }else{
          // 更新现有思维链内容
          const thinkingContent=existingDetails.querySelector('.thinking-content');
          if(thinkingContent){
            thinkingContent.innerHTML=this.sanitizer.sanitize(thinking,true,el);
          }
        }
      }
      
      // 更新主要内容（在思维链之后） —— 改为：方案B（有状态分段渲染，前缀+尾部）
const ensureSpans=()=>{
  let prefixEl=body.querySelector('[data-stream-prefix]');
  let tailEl=body.querySelector('[data-stream-tail]');
  if(!prefixEl || !tailEl){
    // 移除旧的非思维链节点
    Array.from(body.childNodes).forEach(n=>{
      if(!(n.nodeType===1 && n.hasAttribute && n.hasAttribute('data-thinking'))) n.remove();
    });
    prefixEl=document.createElement('span');
    prefixEl.setAttribute('data-stream-prefix','');
    tailEl=document.createElement('span');
    tailEl.setAttribute('data-stream-tail','');
    body.appendChild(prefixEl);
    body.appendChild(tailEl);
  }
  return {prefixEl, tailEl};
};
const {prefixEl, tailEl} = ensureSpans();
// 软锁定：打字中标记
el && el.setAttribute && el.setAttribute('data-streaming','1');

// 取或建状态
const __st = window.__getStreamState(el || body);
const now = performance.now();

// 计算增量：updateTyping(text) 的 text 为“当前完整文本”，我们只喂新增
const deltaText = (typeof text === 'string') ? text.slice(__st.lastLen || 0) : '';
__st.lastLen = (typeof text === 'string') ? text.length : (__st.lastLen||0);

// 喂状态机（只含 3 条即时规则："…", “…”, *…*）
const res = __st.fmt.feed(deltaText);

// 限制我们自己的 DOM 写频率：即便 120Hz，也不会每帧重绘
if (now - __st.lastFlush >= (window.__STREAM_CFG && window.__STREAM_CFG.minGapMs || 16)) {
  __st.lastFlush = now;
  if (prefixEl.innerHTML !== res.prefixHTML) prefixEl.innerHTML = res.prefixHTML;
  tailEl.innerHTML = res.tailHTML + '<span class="typing-cursor"></span>';
}
      
      if(shouldStick&&box && (typeof _lastDeltaChars!=='number' || _lastDeltaChars >= (window.__STREAM_CFG&&window.__STREAM_CFG.scrollDeltaMin||8))){ if(!this._scrollRAF){
          this._scrollRAF=requestAnimationFrame(()=>{
            box.scrollTop=box.scrollHeight;
            this._scrollRAF=null;
          });
        }
      }
    }
  }
  
  removeTyping(el){
    if(this._scrollRAF){
      cancelAnimationFrame(this._scrollRAF);
      this._scrollRAF=null;
    }
    
    if(el){
      if(el.parentNode){
        this.domPool.release('article',el);
        el.remove();
      }
    }
    
    this.typingElement=null;
    this.typingBodyCache=null;  // ✅ 清理缓存
  }
  
  setSending(sending){
    const sendBtn=Utils.$('#send');
    const input=Utils.$('#input');
    const btnSettings=Utils.$('#btnSettings');
    const btnNew=Utils.$('#btnNew');
    
    this.isSending=!!sending;
    
    if(sendBtn&&input){
      if(sending){
        sendBtn.classList.remove('primary');
        sendBtn.classList.add('warn','sending');
        sendBtn.innerHTML='<span class="spinner"></span>停止';
        sendBtn.disabled=false;
        input.disabled=true;
      }else{
        sendBtn.classList.add('primary');
        sendBtn.classList.remove('warn','sending');
        sendBtn.textContent='发送';
        sendBtn.disabled=false;
        input.disabled=false;
      }
    }
    
    const disableButtons=(containerKey)=>{
      const container=Utils.$(containerKey);
      if(container){
        container.querySelectorAll('button').forEach(b=>b.disabled=!!sending);
      }
    };
    
    disableButtons('#composerModelSelector');
    disableButtons('#newChatModelSelector');
    
    if(btnSettings)btnSettings.disabled=!!sending;
    if(btnNew)btnNew.disabled=!!sending;
    
    const sessionList=Utils.$('#sessionList');
    if(sessionList){
      sessionList.querySelectorAll('.btn').forEach(b=>b.disabled=!!sending);
    }
  }
  
  isNearBottom(box){
    return(box.scrollHeight-(box.scrollTop+box.clientHeight))<=CONFIG.AUTO_FOLLOW_PX;
  }
  
  // ... (其余方法保持不变，包括settings相关方法)
  
  loadSettingsUI(){
    if(this._settingsRendered){
      this.fillSettingsValues();
      return;
    }
    
    const presets=this.state.get('modelPresets');
    [1,2].forEach(i=>{
      const preset=presets[i-1]||{enabled:false,name:'',type:'openai',config:{}};
      const enable=Utils.$(`#model${i}Enable`);
      const name=Utils.$(`#model${i}Name`);
      const type=Utils.$(`#model${i}Type`);
      
      if(enable)enable.value=preset.enabled?'true':'false';
      if(name)name.value=preset.name||'';
      if(type)type.value=preset.type||'openai';
      
      this.renderModelConfig(i,preset.type,preset.config);
    });
    
    this.renderPromptPresetList();
    this.updatePromptEditingHint();
    
    this._settingsRendered=true;
  }
  
  fillSettingsValues(){
    const presets=this.state.get('modelPresets');
    [1,2].forEach(i=>{
      const preset=presets[i-1]||{enabled:false,name:'',type:'openai',config:{}};
      const enable=Utils.$(`#model${i}Enable`);
      const name=Utils.$(`#model${i}Name`);
      const type=Utils.$(`#model${i}Type`);
      
      if(enable)enable.value=preset.enabled?'true':'false';
      if(name)name.value=preset.name||'';
      if(type)type.value=preset.type||'openai';
      
      // ✅ 重新渲染config输入框，确保配置被正确填充
      this.renderModelConfig(i,preset.type,preset.config);
    });
    
    this.renderPromptPresetList();
  }
  
  renderModelConfig(index,type,config={}){
    const container=Utils.$(`#model${index}Config`);
    if(!container)return;
    
    if(type==='openai'){
      container.innerHTML=`<div class="field"><label>Base URL</label><input id="m${index}_base" value="${config.base||'https://api.openai.com/v1'}"/></div><div class="field"><label>API Key</label><input id="m${index}_key" type="password" value="${config.key||''}"/></div><div class="field"><label>模型名</label><input id="m${index}_model" value="${config.model||'gpt-4o-mini'}"/></div><div class="sep"></div><div class="field"><label>温度</label><input type="number" id="m${index}_temp" min="0" max="2" step="0.01" value="${config.temperature??''}" placeholder="0=不发送"/></div><div class="field"><label>Top P</label><input type="number" id="m${index}_topP" min="0" max="1" step="0.01" value="${config.top_p??''}" placeholder="0=不发送"/></div><div class="field"><label>最大输出长度</label><input type="number" id="m${index}_maxTokens" min="0" step="1" value="${config.max_tokens??''}" placeholder="0=不发送"/></div><div class="field"><label>流式输出</label><select id="m${index}_stream"><option value="true" ${config.stream?'selected':''}>是</option><option value="false" ${!config.stream?'selected':''}>否</option></select></div><div class="sep"></div><div class="field"><label>启用思维链</label><select id="m${index}_useThinking"><option value="true" ${config.useThinking?'selected':''}>是</option><option value="false" ${!config.useThinking?'selected':''}>否</option></select></div><div class="field"><label>思维链级别</label><select id="m${index}_thinkingEffort"><option value="" ${!config.thinkingEffort?'selected':''}>默认(medium)</option><option value="minimal" ${config.thinkingEffort==='minimal'?'selected':''}>极简</option><option value="low" ${config.thinkingEffort==='low'?'selected':''}>低</option><option value="medium" ${config.thinkingEffort==='medium'?'selected':''}>中</option><option value="high" ${config.thinkingEffort==='high'?'selected':''}>高</option></select></div>`;
    }else if(type==='gemini'){
      container.innerHTML=`<div class="field"><label>Base URL</label><input id="m${index}_base" value="${config.base||'https://generativelanguage.googleapis.com'}"/></div><div class="field"><label>API Key</label><input id="m${index}_key" type="password" value="${config.key||''}"/></div><div class="field"><label>模型名</label><input id="m${index}_model" value="${config.model||'gemini-2.5-flash'}"/></div><div class="sep"></div><div class="field"><label>温度</label><input type="number" id="m${index}_temp" min="0" max="2" step="0.01" value="${config.temperature??''}" placeholder="0=不发送"/></div><div class="field"><label>Top P</label><input type="number" id="m${index}_topP" min="0" max="1" step="0.01" value="${config.top_p??''}" placeholder="0=不发送"/></div><div class="field"><label>Top K</label><input type="number" id="m${index}_topK" min="0" step="1" value="${config.top_k??''}" placeholder="0=不发送"/></div><div class="field"><label>最大输出长度</label><input type="number" id="m${index}_maxTokens" min="0" step="1" value="${config.max_output_tokens??''}" placeholder="0=不发送"/></div><div class="field"><label>流式输出</label><select id="m${index}_stream"><option value="true" ${config.stream?'selected':''}>是</option><option value="false" ${!config.stream?'selected':''}>否</option></select></div><div class="sep"></div><div class="field"><label>启用思维链</label><select id="m${index}_useThinking"><option value="true" ${config.useThinking?'selected':''}>是</option><option value="false" ${!config.useThinking?'selected':''}>否</option></select></div><div class="field"><label>思维预算</label><input type="number" id="m${index}_thinkingBudget" min="-1" step="1" value="${config.thinkingBudget??''}" placeholder="-1=自动,0=禁用"/></div>`;
    }else{
      container.innerHTML=`<div class="field"><label>代理URL</label><input id="m${index}_proxyUrl" value="${config.proxyUrl||'http://127.0.0.1:8889'}"/></div><div class="field"><label>代理密码</label><input id="m${index}_proxyPass" type="password" value="${config.proxyPass||''}" placeholder="可选"/></div><div class="field"><label>模型名</label><input id="m${index}_model" value="${config.model||'gemini-2.5-flash'}"/></div><div class="sep"></div><div class="field"><label>温度</label><input type="number" id="m${index}_temp" min="0" max="2" step="0.01" value="${config.temperature??''}" placeholder="0=不发送"/></div><div class="field"><label>Top P</label><input type="number" id="m${index}_topP" min="0" max="1" step="0.01" value="${config.top_p??''}" placeholder="0=不发送"/></div><div class="field"><label>Top K</label><input type="number" id="m${index}_topK" min="0" step="1" value="${config.top_k??''}" placeholder="0=不发送"/></div><div class="field"><label>最大输出长度</label><input type="number" id="m${index}_maxTokens" min="0" step="1" value="${config.max_output_tokens??''}" placeholder="0=不发送"/></div><div class="field"><label>流式输出</label><select id="m${index}_stream"><option value="true" ${config.stream?'selected':''}>是</option><option value="false" ${!config.stream?'selected':''}>否</option></select></div><div class="sep"></div><div class="field"><label>启用思维链</label><select id="m${index}_useThinking"><option value="true" ${config.useThinking?'selected':''}>是</option><option value="false" ${!config.useThinking?'selected':''}>否</option></select></div><div class="field"><label>思维预算</label><input type="number" id="m${index}_thinkingBudget" min="-1" step="1" value="${config.thinkingBudget??''}" placeholder="-1=自动,0=禁用"/></div>`;
    }
  }
  
  saveSettingsUI(){
    const presets=[];
    [1,2].forEach(i=>{
      const enabled=Utils.$(`#model${i}Enable`)?.value==='true';
      const name=Utils.$(`#model${i}Name`)?.value.trim()||'';
      const type=Utils.$(`#model${i}Type`)?.value||'openai';
      
      // ✅ 无论enabled与否，都读取并保存配置
      const config={};
      if(type==='openai'){
        config.base=Utils.$(`#m${i}_base`)?.value.trim()||'https://api.openai.com/v1';
        config.key=Utils.$(`#m${i}_key`)?.value.trim()||'';
        config.model=Utils.$(`#m${i}_model`)?.value.trim()||'gpt-4o-mini';
        config.temperature=Utils.numOrNull(Utils.$(`#m${i}_temp`)?.value);
        config.top_p=Utils.numOrNull(Utils.$(`#m${i}_topP`)?.value);
        config.max_tokens=Utils.intOrNull(Utils.$(`#m${i}_maxTokens`)?.value);
        config.stream=Utils.$(`#m${i}_stream`)?.value==='true';
        config.useThinking=Utils.$(`#m${i}_useThinking`)?.value==='true';
        config.thinkingEffort=Utils.$(`#m${i}_thinkingEffort`)?.value||'';
      }else if(type==='gemini'){
        config.base=Utils.$(`#m${i}_base`)?.value.trim()||'https://generativelanguage.googleapis.com';
        config.key=Utils.$(`#m${i}_key`)?.value.trim()||'';
        config.model=Utils.$(`#m${i}_model`)?.value.trim()||'gemini-2.0-flash-exp';
        config.temperature=Utils.numOrNull(Utils.$(`#m${i}_temp`)?.value);
        config.top_p=Utils.numOrNull(Utils.$(`#m${i}_topP`)?.value);
        config.top_k=Utils.intOrNull(Utils.$(`#m${i}_topK`)?.value);
        config.max_output_tokens=Utils.intOrNull(Utils.$(`#m${i}_maxTokens`)?.value);
        config.stream=Utils.$(`#m${i}_stream`)?.value==='true';
        config.useThinking=Utils.$(`#m${i}_useThinking`)?.value==='true';
        const budgetVal=Utils.$(`#m${i}_thinkingBudget`)?.value;
        config.thinkingBudget=budgetVal===''?null:parseInt(budgetVal,10);
      }else{
        config.proxyUrl=Utils.$(`#m${i}_proxyUrl`)?.value.trim()||'http://127.0.0.1:8889';
        config.proxyPass=Utils.$(`#m${i}_proxyPass`)?.value.trim()||'';
        config.model=Utils.$(`#m${i}_model`)?.value.trim()||'gemini-2.0-flash-exp';
        config.temperature=Utils.numOrNull(Utils.$(`#m${i}_temp`)?.value);
        config.top_p=Utils.numOrNull(Utils.$(`#m${i}_topP`)?.value);
        config.top_k=Utils.intOrNull(Utils.$(`#m${i}_topK`)?.value);
        config.max_output_tokens=Utils.intOrNull(Utils.$(`#m${i}_maxTokens`)?.value);
        config.stream=Utils.$(`#m${i}_stream`)?.value==='true';
        config.useThinking=Utils.$(`#m${i}_useThinking`)?.value==='true';
        const budgetVal=Utils.$(`#m${i}_thinkingBudget`)?.value;
        config.thinkingBudget=budgetVal===''?null:parseInt(budgetVal,10);
      }
      
      presets.push({enabled,name,type,config});
    });
    
    this.state.set('modelPresets',presets);
    
    const activeCount=presets.filter(p=>p.enabled).length;
    if(activeCount===0)ErrorHandler.show('警告: 至少启用一个模型预设');
    
    if(this.state.get('currentModelIndex')>=activeCount){
      this.state.state.currentModelIndex=0;
    }
    
    this.updateModelSelectors();
  }
  
  renderPromptPresetList(){
    const list=Utils.$('#promptPresetList');
    if(!list)return;
    
    const presets=this.state.get('promptPresets');
    const editing=this.state.get('editingPromptPreset');
    
    const fragment=document.createDocumentFragment();
    Object.keys(presets).sort().forEach(key=>{
      const preset=presets[key];
      const div=document.createElement('div');
      div.className='preset-item'+(editing===key?' active':'');
      div.style.cssText='padding:.6rem;margin-bottom:.4rem;border:1px solid var(--border);border-radius:.5rem;cursor:pointer;background:rgba(21,25,33,.6)';
      div.dataset.preset=key;
      
      div.innerHTML=`<div style="font-weight:600;font-size:13px;margin-bottom:.2rem">${preset.name}</div><div style="font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(preset.sysPrompt||preset.firstAssistant||'空').slice(0,30)}</div>`;
      
      fragment.appendChild(div);
    });
    
    list.innerHTML='';
    list.appendChild(fragment);
  }
  
  fillPromptPresetSelect(){
    // 此方法不再需要，但保留以避免破坏其他调用
  }
  
  updatePromptEditingHint(){
    const hint=Utils.$('#promptEditingHint');
    if(!hint)return;
    
    const editing=this.state.get('editingPromptPreset');
    const presets=this.state.get('promptPresets');
    
    if(editing&&presets[editing]){
      hint.textContent=`正在编辑: ${presets[editing].name}`;
    }else{
      hint.textContent='未选择预设';
    }
  }
  
  loadPromptPreset(key){
    const presets=this.state.get('promptPresets');
    const preset=presets[key];
    if(!preset)return;
    
    const nameInput=Utils.$('#promptPresetName');
    if(nameInput)nameInput.value=preset.name||'';
    if(Utils.$('#sysPrompt'))Utils.$('#sysPrompt').value=preset.sysPrompt||'';
    if(Utils.$('#firstUser'))Utils.$('#firstUser').value=preset.firstUser||'';
    if(Utils.$('#firstAssistant'))Utils.$('#firstAssistant').value=preset.firstAssistant||'';
    if(Utils.$('#messagePrefix'))Utils.$('#messagePrefix').value=preset.messagePrefix||'';
    if(Utils.$('#assistantPrefill'))Utils.$('#assistantPrefill').value=preset.assistantPrefill||'';
    
    this.renderRegexRules(preset.regexRules||[]);
    
    this.state.state.editingPromptPreset=key;
    this.renderPromptPresetList();
    this.updatePromptEditingHint();
  }
  
  renderRegexRules(rules){
    const container=Utils.$('#regexRulesContainer');
    if(!container)return;
    
    if(!rules||rules.length===0){
      container.innerHTML='<div style="color:var(--muted);font-size:11px;padding:.5rem">暂无规则。点击下方按钮添加。</div>';
      return;
    }
    
    const html=rules.map((rule,idx)=>`<div style="display:flex;flex-direction:column;gap:.7rem;padding:1rem;border:1px solid var(--border);border-radius:.75rem;background:linear-gradient(135deg,rgba(21,25,33,.7),rgba(15,18,25,.8));margin-bottom:.75rem" data-idx="${idx}"><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem"><span style="cursor:move;color:var(--muted);font-size:16px;padding:.2rem" title="拖动排序">☰</span><input type="text" style="flex:1;border:1px solid var(--border);border-radius:.5rem;background:rgba(0,0,0,.3);color:var(--fg);padding:.5rem .7rem;font-family:inherit;font-size:13px;font-weight:600" placeholder="规则名称(可选)" data-field="name" value="${rule.name||''}"/><button class="btn small warn" data-action="remove" data-idx="${idx}" title="删除规则">×</button></div><div style="display:grid;gap:.6rem"><div><div style="color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.3rem">查找正则表达式</div><textarea placeholder="例如: \\bAI\\b" data-field="pattern" style="width:100%;border:1px solid var(--border);border-radius:.5rem;background:rgba(0,0,0,.35);color:var(--fg);padding:.6rem .75rem;font-family:'Consolas','Monaco','Courier New',monospace;font-size:13px;line-height:1.5;resize:vertical;min-height:60px">${rule.pattern||''}</textarea></div><div><div style="color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.3rem">替换为</div><textarea placeholder="例如: 人工智能" data-field="replacement" style="width:100%;border:1px solid var(--border);border-radius:.5rem;background:rgba(0,0,0,.35);color:var(--fg);padding:.6rem .75rem;font-family:'Consolas','Monaco','Courier New',monospace;font-size:13px;line-height:1.5;resize:vertical;min-height:60px">${rule.replacement||''}</textarea></div><div><div style="color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.3rem">标志</div><div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;user-select:none"><input type="checkbox" data-flag="g" ${(rule.flags||'g').includes('g')?'checked':''} style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent2)"/><span style="font-size:12px;color:var(--fg)">g (全局)</span></label><label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;user-select:none"><input type="checkbox" data-flag="i" ${(rule.flags||'').includes('i')?'checked':''} style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent2)"/><span style="font-size:12px;color:var(--fg)">i (忽略大小写)</span></label><label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;user-select:none"><input type="checkbox" data-flag="m" ${(rule.flags||'').includes('m')?'checked':''} style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent2)"/><span style="font-size:12px;color:var(--fg)">m (多行)</span></label><label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;user-select:none"><input type="checkbox" data-flag="s" ${(rule.flags||'').includes('s')?'checked':''} style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent2)"/><span style="font-size:12px;color:var(--fg)">s (点匹配换行)</span></label></div></div></div></div>`).join('');
    
    container.innerHTML=html;
  
    // Remove flags UI (g/i/m/s) entirely
    try{
      container.querySelectorAll('[data-flag]').forEach(cb=>{
        const lab = cb.closest('label');
        if(lab && lab.parentElement){ lab.parentElement.removeChild(lab); }
        else if(cb && cb.parentElement){ cb.parentElement.removeChild(cb); }
      });
    }catch(_){}
    }
  
  addRegexRule(){
    const editing=this.state.get('editingPromptPreset');
    if(!editing){
      ErrorHandler.show('请先选择一个提示词预设');
      return;
    }
    
    const presets=this.state.get('promptPresets');
    const preset=presets[editing];
    if(!preset.regexRules)preset.regexRules=[];
    preset.regexRules.push({name:'',pattern:'',replacement:''});
    
    this.renderRegexRules(preset.regexRules);
  }
  
  removeRegexRule(idx){
    const editing=this.state.get('editingPromptPreset');
    if(!editing)return;
    
    const presets=this.state.get('promptPresets');
    const preset=presets[editing];
    if(!preset||!preset.regexRules)return;
    
    preset.regexRules.splice(idx,1);
    this.renderRegexRules(preset.regexRules);
  }
  
  saveRegexRules(){
    const editing=this.state.get('editingPromptPreset');
    if(!editing)return;
    
    const presets={...this.state.get('promptPresets')};
    const preset=presets[editing];
    if(!preset)return;
    
    const container=Utils.$('#regexRulesContainer');
    if(!container)return;
    
    const items=container.querySelectorAll('[data-idx]');
    const rules=[];
    
    items.forEach(item=>{
      const name=item.querySelector('[data-field="name"]')?.value.trim()||'';
      const pattern=item.querySelector('[data-field="pattern"]')?.value.trim();
      const replacement=item.querySelector('[data-field="replacement"]')?.value.trim();
      if(pattern){
        rules.push({name,pattern,replacement});
      }
    });
    
    preset.regexRules=rules;
    this.state.set('promptPresets',presets);
  }
  
  savePromptPreset(){
    const nameInput=Utils.$('#promptPresetName');
    const name=nameInput?.value.trim();
    if(!name){
      ErrorHandler.show('请输入预设名称');
      return;
    }
    
    this.saveRegexRules();
    
    const presets={...this.state.get('promptPresets')};
    const key=name.toLowerCase().replace(/\s+/g,'_');
    
    if(presets[key]){
      if(!confirm(`已存在名为"${name}"的预设，是否覆盖？`))return;
    }
    
    presets[key]={
      name:name,
      sysPrompt:Utils.$('#sysPrompt')?.value.trim()||'',
      firstUser:Utils.$('#firstUser')?.value.trim()||'',
      firstAssistant:Utils.$('#firstAssistant')?.value.trim()||'',
      messagePrefix:Utils.$('#messagePrefix')?.value.trim()||'',
      assistantPrefill:Utils.$('#assistantPrefill')?.value.trim()||'',
      regexRules:this.state.get('promptPresets')[this.state.get('editingPromptPreset')]?.regexRules||[]
    };
    
    this.state.set('promptPresets',presets);
    this.state.state.editingPromptPreset=key;
    this.renderPromptPresetList();
    this.updatePromptEditingHint();
    ErrorHandler.show('预设已保存',2000);
  }
  
  updatePromptPreset(){
    const editing=this.state.get('editingPromptPreset');
    if(!editing){
      ErrorHandler.show('请先选择一个预设');
      return;
    }
    
    this.saveRegexRules();
    
    const presets={...this.state.get('promptPresets')};
    if(!presets[editing]){
      ErrorHandler.show('预设不存在');
      return;
    }
    
    const nameInput=Utils.$('#promptPresetName');
    const name=nameInput?.value.trim()||presets[editing].name;
    
    presets[editing]={
      name:name,
      sysPrompt:Utils.$('#sysPrompt')?.value.trim()||'',
      firstUser:Utils.$('#firstUser')?.value.trim()||'',
      firstAssistant:Utils.$('#firstAssistant')?.value.trim()||'',
      messagePrefix:Utils.$('#messagePrefix')?.value.trim()||'',
      assistantPrefill:Utils.$('#assistantPrefill')?.value.trim()||'',
      regexRules:presets[editing].regexRules||[]
    };
    
    this.state.set('promptPresets',presets);
    this.renderPromptPresetList();
    ErrorHandler.show('预设已更新',2000);
  }
  
  deletePromptPreset(){
    const editing=this.state.get('editingPromptPreset');
    if(!editing){
      ErrorHandler.show('请先选择一个预设');
      return;
    }
    
    if(editing==='default'){
      ErrorHandler.show('无法删除默认预设');
      return;
    }
    
    if(!confirm(`确定删除预设 "${this.state.get('promptPresets')[editing]?.name}"?`))return;
    
    const presets={...this.state.get('promptPresets')};
    delete presets[editing];
    
    this.state.set('promptPresets',presets);
    this.state.state.editingPromptPreset=null;
    
    Utils.$('#promptPresetName').value='';
    Utils.$('#sysPrompt').value='';
    Utils.$('#firstUser').value='';
    Utils.$('#firstAssistant').value='';
    Utils.$('#messagePrefix').value='';
    Utils.$('#assistantPrefill').value='';
    
    this.renderPromptPresetList();
    this.updatePromptEditingHint();
    ErrorHandler.show('预设已删除',2000);
  }
  
  exportAll(){
    const data={
      version:'9.3',
      timestamp:Date.now(),
      modelPresets:this.state.get('modelPresets'),
      promptPresets:this.state.get('promptPresets'),
      sessions:this.state.get('sessions'),
      currentId:this.state.get('currentId')
    };
    this.downloadJSONCompat(data,`chat-backup-all-${this.formatDate()}.json`);
    ErrorHandler.show('导出成功',2000);
  }
  
  exportSessions(){
    const data={
      version:'9.3',
      timestamp:Date.now(),
      sessions:this.state.get('sessions'),
      currentId:this.state.get('currentId')
    };
    this.downloadJSONCompat(data,`chat-backup-sessions-${this.formatDate()}.json`);
    ErrorHandler.show('对话导出成功',2000);
  }
  
  exportPresets(){
    const data={
      version:'9.3',
      timestamp:Date.now(),
      modelPresets:this.state.get('modelPresets'),
      promptPresets:this.state.get('promptPresets')
    };
    this.downloadJSONCompat(data,`chat-backup-presets-${this.formatDate()}.json`);
    ErrorHandler.show('预设导出成功',2000);
  }
  
  downloadJSONCompat(data, filename){
  try{
    const text = JSON.stringify(data, null, 2);
    const blob = new Blob([text], { type: 'application/json' });

    const saveWithAnchor = () => {
      try{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display='none';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
        return true;
      }catch(e){ return false; }
    };

    const saveWithCordova = () => new Promise((resolve,reject)=>{
      try{
        if(!window.cordova || !window.cordova.file || !window.resolveLocalFileSystemURL){
          return reject(new Error('cordova unavailable'));
        }
        const baseDir = window.cordova.file.externalDataDirectory || window.cordova.file.dataDirectory;
        window.resolveLocalFileSystemURL(baseDir, (dirEntry)=>{
          dirEntry.getFile(filename, {create:true, exclusive:false}, (fileEntry)=>{
            fileEntry.createWriter((writer)=>{
              writer.onwriteend = ()=> resolve((fileEntry.nativeURL||fileEntry.toURL()));
              writer.onerror = (e)=> reject(e);
              writer.write(blob);
            }, reject);
          }, reject);
        }, reject);
      }catch(e){ reject(e); }
    });

    if(window.cordova){
      saveWithCordova()
        .then((uri)=>{
          try { ErrorHandler.show('已保存到: ' + (uri||'应用目录'), 3500); } catch(_) {}
        })
        .catch(()=>{ saveWithAnchor(); });
    }else{
      saveWithAnchor();
    }
  }catch(e){
    try { ErrorHandler.show('导出失败: ' + e.message, 4000); } catch(_) {}
  }
}

  
  
  formatDate(){
    const now=new Date();
    return`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
  }
  
  importData(){
    const fileInput=Utils.$('#fileImport');
    if(!fileInput)return;
    
    fileInput.onchange=(e)=>{
      const file=e.target.files[0];
      if(!file)return;
      
      const reader=new FileReader();
      reader.onload=(e)=>{
        try{
          const data=JSON.parse(e.target.result);
          this.processImport(data);
          fileInput.value='';
        }catch(error){
          ErrorHandler.show('文件格式错误: '+error.message);
        }
      };
      reader.readAsText(file);
    };
    
    fileInput.click();
  }
  
  processImport(data){
    if(!data||typeof data!=='object'){
      ErrorHandler.show('无效的备份文件');
      return;
    }
    
    if(!data.version){
      ErrorHandler.show('不支持的备份文件格式');
      return;
    }
    
    const mode=Utils.$('#importMode')?.value||'merge';
    const confirmMsg=mode==='replace'?
      '替换模式将清空所有现有数据!确定继续?':
      '合并模式将保留现有数据并合并导入。确定继续?';
    
    if(!confirm(confirmMsg))return;
    
    try{
      if(mode==='replace'){
        this.state.set('modelPresets',Array.isArray(data.modelPresets)?data.modelPresets:[]);
        this.state.set('promptPresets',data.promptPresets&&typeof data.promptPresets==='object'?data.promptPresets:{});
        this.state.set('sessions',data.sessions&&typeof data.sessions==='object'?data.sessions:{});
        this.state.set('currentId',data.currentId||null);
      }else{
        const mergedModelPresets=[...this.state.get('modelPresets')];
        if(Array.isArray(data.modelPresets)){
          data.modelPresets.forEach(preset=>{
            if(preset&&preset.name&&!mergedModelPresets.find(p=>p.name===preset.name)){
              mergedModelPresets.push(preset);
            }
          });
        }
        this.state.set('modelPresets',mergedModelPresets);
        
        const mergedPromptPresets={...this.state.get('promptPresets')};
        if(data.promptPresets&&typeof data.promptPresets==='object'){
          Object.keys(data.promptPresets).forEach(key=>{
            if(!mergedPromptPresets[key]){
              mergedPromptPresets[key]=data.promptPresets[key];
            }else{
              const newKey=key+'_imported_'+Date.now();
              mergedPromptPresets[newKey]=data.promptPresets[key];
            }
          });
        }
        this.state.set('promptPresets',mergedPromptPresets);
        
        const mergedSessions={...this.state.get('sessions')};
        if(data.sessions&&typeof data.sessions==='object'){
          Object.keys(data.sessions).forEach(key=>{
            const session=data.sessions[key];
            if(!session||!session.history)return;
            
            if(!mergedSessions[key]){
              mergedSessions[key]=session;
            }else{
              const newKey='s'+Date.now()+'_'+Math.random().toString(36).slice(2,9);
              mergedSessions[newKey]=session;
            }
          });
        }
        this.state.set('sessions',mergedSessions);
      }
      
      this.state.forceSave();
      this.ensureSession();
      this.clearMessages();
      this.renderMessages(true);
      this.renderSidebar();
      this.updateModelSelectors();
      ErrorHandler.show('导入成功',2000);
      Utils.$('#dlgSettings')?.close();
    }catch(error){
      ErrorHandler.show('导入失败: '+error.message);
    }
  }
  
  clearAllData(){
    if(!confirm('⚠️ 警告:此操作将清空所有数据且无法恢复!\n\n确定要继续吗?'))return;
    if(!confirm('最后确认:真的要删除所有对话、预设和配置吗?'))return;
    
    this.state.set('modelPresets',[{
      enabled:true,name:'GPT-4',type:'openai',
      config:{base:'https://api.openai.com/v1',key:'',model:'gpt-4o-mini',
        temperature:null,top_p:null,max_tokens:null,stream:false}
    }]);
    
    this.state.set('promptPresets',{
      'default':{name:'默认预设',sysPrompt:'',firstUser:'',firstAssistant:'',
        messagePrefix:'',assistantPrefill:'',regexRules:[]}
    });
    
    this.state.set('sessions',{});
    this.state.set('currentId',null);
    this.state.forceSave();
    
    this.ensureSession();
    this.clearMessages();
    this.renderMessages(true);
    this.renderSidebar();
    this.updateModelSelectors();
    this.updateStorageInfo();
    ErrorHandler.show('所有数据已清空',2000);
  }
  
  renameSession(sessionId){
    const sessions=this.state.get('sessions');
    const session=sessions[sessionId];
    if(!session)return;
    
    const newName=prompt('输入新的对话名称:',session.name);
    if(newName&&newName.trim()&&newName.trim()!==session.name){
      session.name=newName.trim();
      this.state.set('sessions',sessions);
      this.renderSidebar();
    }
  }
  
  updateStorageInfo(){
    const sessions=this.state.get('sessions');
    const modelPresets=this.state.get('modelPresets');
    const promptPresets=this.state.get('promptPresets');
    
    let totalMessages=0;
    Object.values(sessions).forEach(s=>{
      totalMessages+=(s.history||[]).length;
    });
    
    const dataStr=JSON.stringify({modelPresets,promptPresets,sessions});
    const sizeKB=(new Blob([dataStr]).size/1024).toFixed(2);
    
    if(Utils.$('#sessionCount'))Utils.$('#sessionCount').textContent=Object.keys(sessions).length;
    if(Utils.$('#messageCount'))Utils.$('#messageCount').textContent=totalMessages;
    if(Utils.$('#modelPresetCount'))Utils.$('#modelPresetCount').textContent=modelPresets.filter(p=>p.enabled).length;
    if(Utils.$('#promptPresetCount'))Utils.$('#promptPresetCount').textContent=Object.keys(promptPresets).length;
    if(Utils.$('#dataSize'))Utils.$('#dataSize').textContent=`${sizeKB} KB`;
  }
  
  bindEvents(){
    this.bindHeaderEvents();
    this.bindSidebarEvents();
    this.bindComposerEvents();
    this.bindMessageEvents();
    this.bindSettingsEvents();
  }
  
  bindHeaderEvents(){
    const btnSessions=Utils.$('#btnSessions');
    const btnSettings=Utils.$('#btnSettings');
    
    if(btnSessions){
      this.events.on(btnSessions,'click',()=>{
        const sidebar=Utils.$('#sidebar');
        const backdrop=Utils.$('#backdrop');
        const isOpen=!sidebar.hidden&&sidebar.classList.contains('open');
        
        if(isOpen){
          sidebar.classList.remove('open');
          backdrop.classList.remove('show');
          this.events.setTimeout(()=>{
            sidebar.hidden=true;
            backdrop.hidden=true;
          },300);
        }else{
          sidebar.hidden=false;
          backdrop.hidden=false;
          requestAnimationFrame(()=>{
            sidebar.classList.add('open');
            backdrop.classList.add('show');
          });
        }
      });
    }
    
    if(btnSettings){
      this.events.on(btnSettings,'click',()=>{
        this.loadSettingsUI();
        this.updateStorageInfo();
        Utils.$('#dlgSettings')?.showModal();
      });
    }
  }
  
  bindSidebarEvents(){
    const backdrop=Utils.$('#backdrop');
    const sessionList=Utils.$('#sessionList');
    const btnNew=Utils.$('#btnNew');
    
    if(backdrop){
      this.events.on(backdrop,'click',()=>{
        const sidebar=Utils.$('#sidebar');
        sidebar.classList.remove('open');
        backdrop.classList.remove('show');
        this.events.setTimeout(()=>{
          sidebar.hidden=true;
          backdrop.hidden=true;
        },300);
      });
    }
    
    if(sessionList){
      this.events.on(sessionList,'click',(e)=>{
        const openBtn=e.target.closest('[data-open]');
        const delBtn=e.target.closest('[data-del]');
        const renameTarget=e.target.closest('[data-act="rename-session"]');
        const sidebar=Utils.$('#sidebar');
        const backdrop=Utils.$('#backdrop');
        
        if(renameTarget){
          const sessionId=renameTarget.dataset.sessionId;
          this.renameSession(sessionId);
          return;
        }
        
        if(openBtn){
          // ✅ 切换会话前自动保存正在编辑的消息
          this.autoSaveEditingMessage();
          
          this.state.set('currentId',openBtn.dataset.open);
          this.clearMessages();
          this.renderMessages(true);
          this.renderSidebar();
          this.setupTopObserver();
    if(this._setupIMEHandlers) this._setupIMEHandlers();
    if(this._updateBottomPadding) this._updateBottomPadding();
          
          sidebar.classList.remove('open');
          backdrop.classList.remove('show');
          this.events.setTimeout(()=>{
            sidebar.hidden=true;
            backdrop.hidden=true;
          },300);
        }
        
        if(delBtn){
          if(confirm('删除该对话?')){
            const sessions={...this.state.get('sessions')};
            const delId=delBtn.dataset.del;
            delete sessions[delId];
            
            let newId=this.state.get('currentId');
            if(newId===delId)newId=Object.keys(sessions)[0]||null;
            
            this.state.set('sessions',sessions);
            this.state.set('currentId',newId);
            
            if(newId){
              this.clearMessages();
              this.renderMessages(true);
              this.setupTopObserver();
    if(this._setupIMEHandlers) this._setupIMEHandlers();
    if(this._updateBottomPadding) this._updateBottomPadding();
            }else{
              this.createNewSession();
            }
            
            this.renderSidebar();
          }
        }
      });
    }
    
    if(btnNew){
      this.events.on(btnNew,'click',()=>this.showPresetSelector());
    }
    
    const newChatSelector=Utils.$('#newChatModelSelector');
    if(newChatSelector){
      this.events.on(newChatSelector,'click',(e)=>{
        const btn=e.target.closest('button[data-index]');
        if(!btn)return;
        this.state.state.currentModelIndex=+btn.dataset.index;
        this.updateModelSelectors();
      });
    }
  }
  
  bindComposerEvents(){
    const input=Utils.$('#input');
    const sendBtn=Utils.$('#send');
    if(this._vvAvailable && sendBtn){
      this.events.on(sendBtn,'pointerdown',()=>{ this.freezeViewport(); });
    }

    // Mobile IME hide/show can cause viewport resize flicker; freeze during blur
    if(this._vvAvailable && input){
      this.events.on(input,'blur',()=>{ this.freezeViewport(); });
      this.events.on(input,'focus',()=>{ this.unfreezeViewport(); });
    }
    
    if(input){
      this.events.on(input,'keydown',(e)=>{
        if(e.key==='Enter'&&!e.shiftKey){
          e.preventDefault();
          if(!this.isSending)this.sendMessage();
        }
      });
    }
    
    if(sendBtn){
      this.events.on(sendBtn,'click',()=>{
        if(this.isSending)this.api.abort();
        else this.sendMessage();
      });
    }
    
    const composerSelector=Utils.$('#composerModelSelector');
    if(composerSelector){
      this.events.on(composerSelector,'click',(e)=>{
        const btn=e.target.closest('button[data-index]');
        if(!btn)return;
        this.state.state.currentModelIndex=+btn.dataset.index;
        this.updateModelSelectors();
      });
    }
  }
  
  bindMessageEvents(){
    const messages=Utils.$('#messages');
    if(!messages)return;
    
    this.events.on(messages,'click',(e)=>{
      const btn=e.target.closest('button[data-act]');
      if(!btn)return;
      
      if(this.isSending&&btn.dataset.act!=='cancel-edit'){
        ErrorHandler.show('请等待当前消息发送完成');
        return;
      }
      
      const idx=btn.dataset.idx?+btn.dataset.idx:null;
      const msgId=btn.dataset.msgId;
      const session=this.state.getActiveSession();
      
      if(btn.dataset.act==='del'){
        if(this.isMessageEditing()){
          ErrorHandler.show('请先完成或取消正在进行的编辑');
          return;
        }
        
        const msgId=btn.dataset.msgId;
        const msgIdx=session.history.findIndex(m=>m.id===msgId);
        if(msgIdx===-1)return;
        
        this.preserveScroll(()=>{
          session.history.splice(msgIdx,1);
          const el=this.messageElements.get(msgId);
          if(el){
            this.animateOut(el).then(()=>{
              el.remove();
              this.domPool.release('article',el);
              this.messageElements.delete(msgId);
              this.renumberMessagesFrom(Math.max(0,msgIdx));
              const box=Utils.$('#messages');
              if(box){ this.updateLoadTip(box,this.windowManager.window); }
            });
          }
          this.windowManager.evaluate(session.history.length);
          this.state.set('sessions',this.state.get('sessions'));
        });

        
      }else if(btn.dataset.act==='edit'){
        if(this.isMessageEditing()){
          ErrorHandler.show('请先完成或取消正在进行的编辑');
          return;
        }
        const msgId=btn.dataset.msgId;
        this.startEditMessage(msgId);
        
      }else if(btn.dataset.act==='save-edit'){
        this.saveEditMessage(msgId);
        
      }else if(btn.dataset.act==='cancel-edit'){
        this.cancelEditMessage(msgId);
        
      }else if(btn.dataset.act==='regen'){
        if(this.isMessageEditing()){
          ErrorHandler.show('请先完成或取消正在进行的编辑');
          return;
        }
        
        const msgId=btn.dataset.msgId;
        const msgIdx=session.history.findIndex(m=>m.id===msgId);
        if(msgIdx===-1){
          ErrorHandler.show('未找到消息');
          return;
        }
        
        const userIdx=session.history.slice(0,msgIdx).reverse().findIndex(m=>m.role==='user');
        if(userIdx===-1){
          ErrorHandler.show('未找到可重新生成的用户消息');
          return;
        }
        
        const actualIdx=msgIdx-1-userIdx;
        const removedMsgs=session.history.splice(actualIdx+1);
        
        // 清理删除的消息DOM
        removedMsgs.forEach(msg=>{
          const el=this.messageElements.get(msg.id);
          if(el){
            el.remove();
            this.domPool.release('article',el);
            this.messageElements.delete(msg.id);
          }
        });
        
        this.windowManager.evaluate(session.history.length);
        this.state.set('sessions',this.state.get('sessions'));
        this.sendMessage();
        
      }else if(btn.dataset.act==='rename-session'){
        this.renameSession(btn.dataset.sessionId);
      }
    });
  }
  
  isMessageEditing(){
    const messages=Utils.$('#messages');
    if(!messages)return false;
    return!!messages.querySelector('textarea.edit-box');
  }
  
  startEditMessage(msgId){
    const session=this.state.getActiveSession();
    const msg=session.history.find(m=>m.id===msgId);
    if(!msg)return;
    
    const el=this.messageElements.get(msgId);
    if(!el)return;
    
    const bodyEl=el.querySelector('.body');
    if(!bodyEl)return;
    
    const originalContent=msg.content||'';
    bodyEl.dataset.originalContent=originalContent;
    bodyEl.dataset.editingMessageId=msg.id;
    
    // ✅ 记录编辑状态
    this.editingState={
      msgId:msg.id,
      originalContent:originalContent
    };
    
    const textarea=document.createElement('textarea');
    textarea.className='edit-box';
    textarea.value=originalContent;
    textarea.dataset.messageId=msg.id;
    
    bodyEl.innerHTML='';
    bodyEl.appendChild(textarea);
    
    const footer=el.querySelector('footer');
    if(footer){
      footer.innerHTML=`<button class="btn small primary" data-act="save-edit" data-msg-id="${msg.id}">保存</button><button class="btn small" data-act="cancel-edit" data-msg-id="${msg.id}">取消</button>`;
    }
    
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length,textarea.value.length);
  }
  
  saveEditMessage(msgId){
    const messages=Utils.$('#messages');
    const textarea=messages.querySelector(`textarea[data-message-id="${msgId}"]`);
    if(!textarea)return;
    
    const session=this.state.getActiveSession();
    const msg=session.history.find(m=>m.id===msgId);
    if(!msg)return;
    
    const newContent=textarea.value.trim();
      // === BEGIN PATCH: apply custom regex rules on edited content (Scheme A) ===
      const pc = this.state.getSessionPromptConfig(this.state.getActiveSession && this.state.getActiveSession());
      let finalContent = newContent;
      try {
        if (pc && pc.regexRules && pc.regexRules.length) {
          const compiled = this.regexProcessor && this.regexProcessor.compileRules
            ? this.regexProcessor.compileRules(pc.regexRules)
            : null;
          if (compiled && this.regexProcessor && this.regexProcessor.process) {
            finalContent = this.regexProcessor.process(newContent, compiled);
          }
        }
      } catch (e) {
        console && console.warn && console.warn('Regex processing failed during saveEditMessage:', e);
        // fall back to unprocessed text
        finalContent = newContent;
      }
      // === END PATCH ===

    if(!newContent){
      ErrorHandler.show('消息内容不能为空');
      return;
    }
    
    msg.content=finalContent;
    
    const bodyEl=textarea.closest('.body');
    bodyEl.innerHTML=this.sanitizer.sanitize(finalContent);
    delete bodyEl.dataset.originalContent;
    delete bodyEl.dataset.editingMessageId;
    
    const msgEl=bodyEl.closest('.msg');
    const footer=msgEl.querySelector('footer');
    const idx=session.history.indexOf(msg);
    
    if(footer){
      footer.innerHTML=`<button class="btn small" data-act="edit" data-msg-id="${msg.id}">编辑</button>${
        msg.role==='assistant'?`<button class="btn small" data-act="regen" data-msg-id="${msg.id}">重新生成</button>`:''
      }<button class="btn small warn" data-act="del" data-msg-id="${msg.id}">删除</button>`;
    }
    
    // ✅ 清理编辑状态
    this.editingState=null;
    
    this.state.set('sessions',this.state.get('sessions'));
  }
  
  cancelEditMessage(msgId){
    const messages=Utils.$('#messages');
    const textarea=messages.querySelector(`textarea[data-message-id="${msgId}"]`);
    if(!textarea)return;
    
    const session=this.state.getActiveSession();
    const msg=session.history.find(m=>m.id===msgId);
    if(!msg)return;
    
    const bodyEl=textarea.closest('.body');
    const originalContent=bodyEl.dataset.originalContent||msg.content||'';
    
    bodyEl.innerHTML=this.sanitizer.sanitize(originalContent);
    delete bodyEl.dataset.originalContent;
    delete bodyEl.dataset.editingMessageId;
    
    const msgEl=bodyEl.closest('.msg');
    const footer=msgEl.querySelector('footer');
    const idx=session.history.indexOf(msg);
    
    if(footer){
      footer.innerHTML=`<button class="btn small" data-act="edit" data-msg-id="${msg.id}">编辑</button>${
        msg.role==='assistant'?`<button class="btn small" data-act="regen" data-msg-id="${msg.id}">重新生成</button>`:''
      }<button class="btn small warn" data-act="del" data-msg-id="${msg.id}">删除</button>`;
    }
    
    // ✅ 清理编辑状态
    this.editingState=null;
  }
  
  // ✅ 自动保存正在编辑的消息
  autoSaveEditingMessage(){
    if(!this.editingState)return;
    
    const msgId=this.editingState.msgId;
    const messages=Utils.$('#messages');
    const textarea=messages?.querySelector(`textarea[data-message-id="${msgId}"]`);
    
    // 如果找不到textarea，说明DOM已被清理，直接清理状态
    if(!textarea){
      this.editingState=null;
      return;
    }
    
    const session=this.state.getActiveSession();
    const msg=session?.history.find(m=>m.id===msgId);
    if(!msg){
      this.editingState=null;
      return;
    }
    
    const newContent=textarea.value.trim();
    
    // 如果内容有变化且不为空，自动保存
    if(newContent&&newContent!==this.editingState.originalContent){
      msg.content=finalContent;
      this.state.set('sessions',this.state.get('sessions'));
    }
    
    // 清理编辑状态
    this.editingState=null;
  }
  
  bindSettingsEvents(){
    const tabs=Utils.$('#dlgSettings .tabs');
    if(tabs){
      this.events.on(tabs,'click',(e)=>{
        const btn=e.target.closest('button[data-pane]');
        if(!btn)return;
        
        Utils.$$('#dlgSettings .tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        
        const pane=btn.dataset.pane;
        Utils.$$('#dlgSettings .pane').forEach(p=>p.hidden=true);
        const targetPane=Utils.$(`#pane-${pane}`);
        if(targetPane)targetPane.hidden=false;
        
        if(pane==='backup')this.updateStorageInfo();
      });
    }
    
    const btnClose=Utils.$('#btnCloseSettings');
    const btnApply=Utils.$('#btnApplySettings');
    
    if(btnClose)this.events.on(btnClose,'click',()=>Utils.$('#dlgSettings')?.close());
    
    if(btnApply){
      this.events.on(btnApply,'click',()=>{
        this.saveSettingsUI();
        Utils.$('#dlgSettings')?.close();
        this.clearMessages();
        this.renderMessages(true);
      });
    }
    
    [1,2].forEach(i=>{
      const typeSelect=Utils.$(`#model${i}Type`);
      if(typeSelect){
        this.events.on(typeSelect,'change',()=>{
          this.renderModelConfig(i,typeSelect.value,{});
        });
      }
    });
    
    const promptPresetList=Utils.$('#promptPresetList');
    if(promptPresetList){
      this.events.on(promptPresetList,'click',(e)=>{
        const item=e.target.closest('[data-preset]');
        if(item)this.loadPromptPreset(item.dataset.preset);
      });
    }
    
    const btnSavePrompt=Utils.$('#btnSavePromptPreset');
    const btnUpdatePrompt=Utils.$('#btnUpdatePromptPreset');
    const btnDeletePrompt=Utils.$('#btnDeletePromptPreset');
    
    if(btnSavePrompt)this.events.on(btnSavePrompt,'click',()=>this.savePromptPreset());
    if(btnUpdatePrompt)this.events.on(btnUpdatePrompt,'click',()=>this.updatePromptPreset());
    if(btnDeletePrompt)this.events.on(btnDeletePrompt,'click',()=>this.deletePromptPreset());
    
    const defaultPromptSelect=Utils.$('#defaultPromptPreset');
    if(defaultPromptSelect){
      this.events.on(defaultPromptSelect,'change',()=>{
        this.state.set('defaultPromptPreset',defaultPromptSelect.value);
      });
    }
    
    const btnExportAll=Utils.$('#btnExportAll');
    const btnExportSessions=Utils.$('#btnExportSessions');
    const btnExportPresets=Utils.$('#btnExportPresets');
    const btnImport=Utils.$('#btnImport');
    const btnClearAll=Utils.$('#btnClearAll');
    
    if(btnExportAll)this.events.on(btnExportAll,'click',()=>this.exportAll());
    if(btnExportSessions)this.events.on(btnExportSessions,'click',()=>this.exportSessions());
    if(btnExportPresets)this.events.on(btnExportPresets,'click',()=>this.exportPresets());
    if(btnImport)this.events.on(btnImport,'click',()=>this.importData());
    if(btnClearAll)this.events.on(btnClearAll,'click',()=>this.clearAllData());
    
    const btnAddRegexRule=Utils.$('#btnAddRegexRule');
    if(btnAddRegexRule)this.events.on(btnAddRegexRule,'click',()=>this.addRegexRule());
    
    const regexContainer=Utils.$('#regexRulesContainer');
    if(regexContainer){
      this.events.on(regexContainer,'click',(e)=>{
        const removeBtn=e.target.closest('[data-action="remove"]');
        if(removeBtn){
          const idx=parseInt(removeBtn.dataset.idx);
          if(!isNaN(idx))this.removeRegexRule(idx);
        }
      });
      
      this.events.on(regexContainer,'change',(e)=>{
        if(e.target.matches('[data-field],[data-flag]')){
          this.saveRegexRules();
        }
      });
      
      if(!this._regexInputDebounced){
        this._regexInputDebounced=Utils.debounce((e)=>{
          if(e.target.matches('[data-field]')){
            this.saveRegexRules();
          }
        },500);
      }
      
      this.events.on(regexContainer,'input',this._regexInputDebounced);
    }
    
    // 预设选择对话框事件
    const btnCancelSelectPreset=Utils.$('#btnCancelSelectPreset');
    if(btnCancelSelectPreset){
      this.events.on(btnCancelSelectPreset,'click',()=>{
        Utils.$('#dlgSelectPreset')?.close();
      });
    }
    
    const presetSelectGrid=Utils.$('#presetSelectGrid');
    if(presetSelectGrid){
      this.events.on(presetSelectGrid,'click',(e)=>{
        const card=e.target.closest('.preset-card');
        if(!card)return;
        
        const presetKey=card.dataset.presetKey;
        if(presetKey){
          Utils.$('#dlgSelectPreset')?.close();
          this.createNewSession(presetKey);
          
          // 关闭侧边栏（如果是移动端打开的话）
          const sidebar=Utils.$('#sidebar');
          const backdrop=Utils.$('#backdrop');
          if(sidebar&&!sidebar.hidden){
            sidebar.classList.remove('open');
            backdrop.classList.remove('show');
            setTimeout(()=>{
              sidebar.hidden=true;
              backdrop.hidden=true;
            },300);
          }
        }
      });
    }
  }
  
  cleanup(){
    this.observerMgr.cleanupAll();
    this.api.abort();
    this.events.cleanup();
    this.dom.clear();
    this.domPool.clear();
    this.clearMessages();
    this.state.forceSave();
    
    if(window._sanitizer===this.sanitizer){
      window._sanitizer=null;
    }
  }


  /* ===== IME-aware auto scroll & bottom padding ===== */
  _setupIMEHandlers(){
    const box = Utils.$('#messages');
    const input = Utils.$('#input');
    if(!box) return;
    this._ime = {
      active: false,
      baseVVH: (this._vvAvailable ? visualViewport.height : null),
      wasNearBottom: false,
    };
    // updater
    this._updateBottomPadding = ()=>{
      const composer = document.querySelector('.composer');
      const composerH = composer ? (composer.offsetHeight || 0) : 0;
      let vvInset = 0;
      if(this._vvAvailable){
        try{
          const ov = Math.max(0, (window.innerHeight - visualViewport.height - visualViewport.offsetTop));
          vvInset = ov;
        }catch(e){}
      }
      const pad = Math.round(composerH + vvInset + 8);
      box.style.setProperty('--composer-pad', pad + 'px');
    };
    const updatePad = Utils.rafThrottle(()=> this._updateBottomPadding());

    this._smoothStickBottom = (duration=220)=>{
      const start = box.scrollTop;
      const target = box.scrollHeight - box.clientHeight;
      if(target - start < 2) return;
      const t0 = performance.now();
      const ease = t => (t<.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2);
      const step = (now)=>{
        const p = Math.min(1,(now - t0)/duration);
        box.scrollTop = start + (target - start) * ease(p);
        if(p<1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    if(input){
      this.events.on(input, 'focus', ()=>{
        this._ime.active = true;
        this._ime.wasNearBottom = this.isNearBottom(box);
        updatePad();
      });
      this.events.on(input, 'blur', ()=>{
        this._ime.active = false;
        setTimeout(()=>{
          updatePad();
          if(this.isNearBottom(box)) this._smoothStickBottom(180);
        }, 60);
      });
    }

    if(this._vvAvailable){
      const onVVResize = Utils.rafThrottle(()=>{
        updatePad();
        const h = visualViewport.height;
        if(this._ime.baseVVH == null) this._ime.baseVVH = h;
        const delta = (this._ime.baseVVH - h);
        const keyboardLikelyOpen = delta > 80;
        if(keyboardLikelyOpen && this._ime.active && this._ime.wasNearBottom){
          requestAnimationFrame(()=> this._smoothStickBottom(220));
        }
      });
      this.events.on(visualViewport, 'resize', onVVResize, {passive:true});
      this.events.on(visualViewport, 'scroll', updatePad, {passive:true});
    }

    this.events.on(window, 'resize', updatePad, {passive:true});
    requestAnimationFrame(()=> this._updateBottomPadding());
  }
}

// ===== ChatApp =====
class ChatApp{
  constructor(){
    this.state=new StateManager();
    this.api=new APIManager(this.state);
    this.ui=new UIManager(this.state,this.api);
  }
  
  async init(){
    await this.ui.init();
    
    window.addEventListener('beforeunload',()=>{
      this.ui.cleanup();
    });
    
    window.addEventListener('visibilitychange',()=>{
      if(document.hidden){
        this.state.forceSave();
      }
    });
  }
}

// ===== Initialize =====
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',async()=>{
    const app=new ChatApp();
    await app.init();
    window.chatApp=app;
  });
}else{
  (async()=>{
    const app=new ChatApp();
    await app.init();
    window.chatApp=app;
  })();
}

})();
</script>

<!-- ✅ 保留有效的优化补丁 -->
<script>
(function(){
  'use strict';
  
  // ✅ 1. ScrollScheduler - 读写分离
  class __Scheduler{
    constructor(){
      this.reads=[];
      this.writes=[];
      this.scheduled=false;
    }
    read(job){
      if(typeof job==='function'){
        this.reads.push(job);
        this.schedule();
      }
    }
    write(job){
      if(typeof job==='function'){
        this.writes.push(job);
        this.schedule();
      }
    }
    schedule(){
      if(this.scheduled)return;
      this.scheduled=true;
      requestAnimationFrame(()=>{
        const r=this.reads.splice(0);
        for(let i=0;i<r.length;i++){try{r[i]();}catch{}}
        const w=this.writes.splice(0);
        for(let i=0;i<w.length;i++){try{w[i]();}catch{}}
        this.scheduled=false;
        if(this.reads.length||this.writes.length)this.schedule();
      });
    }
  }
  if(!window.ScrollScheduler)window.ScrollScheduler=new __Scheduler();
  
  // ✅ 2. maybeStickToBottom helper
  function __maybeStickToBottom(box,thresholdPx){
    try{
      if(!box)return;
      const thr=typeof thresholdPx==='number'?thresholdPx:60;
      const nearBottom=(box.scrollHeight-(box.scrollTop+box.clientHeight))<=thr;
      if(nearBottom){
        ScrollScheduler.write(()=>{box.scrollTop=box.scrollHeight;});
      }
    }catch(e){}
  }
  
  // ✅ 3. ResizeObserver for auto-scroll
  try{
    const box=document.querySelector('#messages');
    if(box&&'ResizeObserver'in window){
      const ro=new ResizeObserver(()=>__maybeStickToBottom(box));
      ro.observe(box);
    }
  }catch(e){}
  
})();
</script>

<script src="cordova.js"></script>

<!-- Cordova immersive & IME script -->
<script>
(function(){
  function enterImmersive(){
    try {
      if (window.StatusBar && typeof StatusBar.hide === 'function') {
        StatusBar.overlaysWebView(true);
        StatusBar.hide();
      }
      if (window.AndroidFullScreen && typeof AndroidFullScreen.immersiveMode === 'function') {
        AndroidFullScreen.immersiveMode(function(){}, function(){});
      }
    } catch (e) {}
  }

  document.addEventListener('deviceready', function () {
    enterImmersive();
    document.addEventListener('resume', enterImmersive, false);
    window.addEventListener('focus', enterImmersive, true);

    // ionic-keyboard plugin events (if available)
    window.addEventListener('keyboardWillShow', function () {
      document.body.classList.add('kb-open');
    }, false);
    window.addEventListener('keyboardDidHide', function () {
      document.body.classList.remove('kb-open');
      enterImmersive();
    }, false);
  }, false);

  // Safety: adjust padding-bottom on IME resize and center focused field
  (function () {
    const apply = () => {
      const el = document.activeElement;
      let kb = 0;
      if (window.visualViewport) {
        kb = Math.max(0, window.innerHeight - window.visualViewport.height);
      }
      document.body.style.paddingBottom = kb + 'px';
      if (el && /^(input|textarea|select)$/i.test(el.tagName)) {
        setTimeout(() => el.scrollIntoView({ block: 'center', behavior: 'smooth' }), 50);
      }
    };
    window.addEventListener('focusin', apply);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', apply);
    }
  })();
})();
</script>

<script>
// === StreamB: Stateful inline formatter & scheduler ===
(function(){
  window.__STREAM_CFG = window.__STREAM_CFG || {
    minGapMs: 16,
    nearBottomPx: 120,
    scrollDeltaMin: 8
  };
  class StreamFormatterB {
    constructor(){ this.reset(); }
    reset(){
      this.prefixHTML = "";
      this.open = { dq:false, cq:false, bold:false };
      this.buf  = { dq:"", cq:"", bold:"", plain:"" };
    }
    _esc(s){ return String(s).replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    _commitPlain(){ if(this.buf.plain){ this.prefixHTML += this._esc(this.buf.plain); this.buf.plain=""; } }
    _close(type){
      const t=this.buf[type]; if(!t){ this.open[type]=false; return; }
      if(type==='dq')   this.prefixHTML += `<em class="em-green">"${this._esc(t)}"</em>`;
      if(type==='cq')   this.prefixHTML += `<em class="em-green">“${this._esc(t)}”</em>`;
      if(type==='bold') this.prefixHTML += `<em class="em-yellow">${this._esc(t)}</em>`;
      this.buf[type]=""; this.open[type]=false;
    }
    _open(type){ this._commitPlain(); this.open[type]=true; }
    feed(delta){
      for(const ch of String(delta)){
        // half-width double quote
        if(ch === '"' && !this.open.cq && !this.open.bold){
          this.open.dq ? this._close('dq') : this._open('dq'); continue;
        }
        // chinese quotes
        if(ch === '“' && !this.open.dq && !this.open.bold){ this._open('cq'); continue; }
        if(ch === '”' &&  this.open.cq){ this._close('cq'); continue; }
        // asterisk (half or full width)
        if((ch === '*' || ch.charCodeAt(0) === 0xFF0A) && !this.open.dq && !this.open.cq){
          this.open.bold ? this._close('bold') : this._open('bold'); continue;
        }
        if(this.open.dq) this.buf.dq += ch;
        else if(this.open.cq) this.buf.cq += ch;
        else if(this.open.bold) this.buf.bold += ch;
        else this.buf.plain += ch;
      }
      const parts=[];
      if(this.open.dq)   parts.push(`<span data-incomplete="dq">"${this._esc(this.buf.dq)}`);
      if(this.open.cq)   parts.push(`<span data-incomplete="cq">“${this._esc(this.buf.cq)}`);
      if(this.open.bold) parts.push(`<span data-incomplete="bold">*</span>${this._esc(this.buf.bold)}`);
      if(this.buf.plain) parts.push(this._esc(this.buf.plain));
      return { prefixHTML:this.prefixHTML, tailHTML:parts.join('') };
    }
    fullRaw(){
      return this.prefixHTML.replace(/<[^>]+>/g,'')
           + (this.open.dq   ? '"'+this.buf.dq   : '')
           + (this.open.cq   ? '“'+this.buf.cq   : '')
           + (this.open.bold ? '*'+this.buf.bold : '')
           + this.buf.plain;
    }
  }
  window.__streamState = window.__streamState || new WeakMap();
  window.__getStreamState = function(el){
    let st = window.__streamState.get(el);
    if(!st){
      st = { fmt:new StreamFormatterB(), lastLen:0, lastFlush:0 };
      window.__streamState.set(el, st);
    }
    return st;
  };
})();
// === End StreamB ===
</script>
</body>
</html>
